
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Operations: array and matrix/vector algebras &#8212; TRIQS 3.0.2 documentation</title>
    <link rel="stylesheet" href="../../../../_static/triqs.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=default"></script>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Using basic concepts" href="play_with_concept.html" />
    <link rel="prev" title="Functional constructs: map &amp; fold" href="map.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
    <script src="../../../../_static/cufon-yui.js" type="text/javascript"></script>
    <script src="../../../../_static/spaceman.cufonfonts.js" type="text/javascript"></script>
    <script type="text/javascript">
      Cufon.replace('.triqs', { fontFamily: 'spaceman', hover: true }); 
    </script>
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>

  </head><body>
<div class="pageheader">
  <ul>
    
    <li><a href="../../../../install.html">Install</a></li>
    
    <li><a href="../../../../documentation.html">Documentation</a></li>
    
    <li><a href="../../../../userguide.html">User guide</a></li>
    
    <li><a href="../../../../applications.html">Applications</a></li>
    
    <li><a href="../../../../contributing.html">Contributing</a></li>
    
    <li><a href="../../../../about.html">About TRIQS</a></li>
    
  </ul>
  <div>
    <h1 style="padding:0; margin: 10px 0 0 0;"><a class="triqs" href="../../../../index.html">triqs</a></h1>
    <span style="font-size: 14px; margin: 0px; padding: 0px;">a Toolbox for Research on Interacting Quantum Systems</span>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="play_with_concept.html" title="Using basic concepts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="map.html" title="Functional constructs: map &amp; fold"
             accesskey="P">previous</a> |</li>
    <li><a href="../../../../index.html">Home</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../contents.html" >&lt;no title&gt;</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="contents.html" accesskey="U"><strong>[triqs/arrays]</strong> Multidimensional arrays</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Operations: array and matrix/vector algebras</a><ul>
<li><a class="reference internal" href="#arithmetic-operations">Arithmetic operations</a></li>
<li><a class="reference internal" href="#arrays-vs-matrices">Arrays vs matrices</a></li>
<li><a class="reference internal" href="#performance">Performance</a></li>
<li><a class="reference internal" href="#expressions-are-lazy">Expressions are lazy….</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="map.html"
                        title="previous chapter">Functional constructs: map &amp; fold</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="play_with_concept.html"
                        title="next chapter">Using basic concepts</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/documentation/manual/triqs/arrays/algebras.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="operations-array-and-matrix-vector-algebras">
<h1>Operations: array and matrix/vector algebras<a class="headerlink" href="#operations-array-and-matrix-vector-algebras" title="Permalink to this headline">¶</a></h1>
<div class="section" id="arithmetic-operations">
<h2>Arithmetic operations<a class="headerlink" href="#arithmetic-operations" title="Permalink to this headline">¶</a></h2>
<p>Arrays and matrices can be combined in formal algebraic expressions, which models the <a class="reference internal" href="concepts.html#immutablecuboidarray"><span class="std std-ref">ImmutableCuboidArray</span></a> concept.
This algebraic expressions can therefore be used in assignment array/matrix contructors.
For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;triqs/arrays.hpp&gt;</span><span class="cp"></span>
<span class="n">using</span> <span class="n">triqs</span><span class="o">::</span><span class="n">arrays</span><span class="o">::</span><span class="n">array</span><span class="p">;</span>
<span class="n">using</span> <span class="n">triqs</span><span class="o">::</span><span class="n">clef</span><span class="o">::</span><span class="n">placeholder</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// init</span>
  <span class="n">placeholder</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">i_</span><span class="p">;</span>
  <span class="n">placeholder</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">j_</span><span class="p">;</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">j_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i_</span> <span class="o">+</span> <span class="n">j_</span><span class="p">;</span>
  <span class="n">B</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">j_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i_</span> <span class="o">-</span> <span class="n">j_</span><span class="p">;</span>

  <span class="c1">// use expressions</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">C</span>   <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B</span><span class="p">;</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">D</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">A</span><span class="p">;</span> <span class="c1">// Type promotion is automatic</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;B= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;C= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">C</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;D= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">D</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="arrays-vs-matrices">
<h2>Arrays vs matrices<a class="headerlink" href="#arrays-vs-matrices" title="Permalink to this headline">¶</a></h2>
<p>Because their multiplication is not the same, arrays and matrices algebras cannot be mixed.
Mixing them in expression would therefore be meaningless and it is therefore not allowed.
However, you can always use e.g. <cite>matrix_view</cite> from a array of rank 2 :</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;triqs/arrays.hpp&gt;</span><span class="cp"></span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">triqs</span><span class="o">::</span><span class="n">arrays</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">matrix</span><span class="o">&lt;</span><span class="kt">long</span><span class="o">&gt;</span> <span class="n">M</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="c1">// M + A; // --&gt; ERROR. Rejected by the compiler.</span>
  <span class="n">M</span> <span class="o">+</span> <span class="n">make_matrix_view</span><span class="p">(</span><span class="n">A</span><span class="p">);</span> <span class="c1">//--&gt; OK.</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Making such a view is very cheap, it only copies the index systems. Nevertheless
this can still cause significant overhead in very intense loops by disturbing
optimizers.</p>
</div>
</div>
<div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>The performance of such compact writing is as good as “hand-written” code or even better.</p>
<p>Indeed, the operations are implemented with the <cite>expression templates</cite> technique.
The principle is that the result of A+B is <strong>NOT</strong> an array, but a more complex type which stores
the expression using the naturally recursive structure of templates.</p>
<p>Expressions models <a class="reference internal" href="concepts.html#immutablecuboidarray"><span class="std std-ref">ImmutableCuboidArray</span></a> concept.
They behave like an immutable array: they have a domain, they can be evaluated.
Hence they can used <em>anywhere</em> an object modeling this concept is accepted, e.g.:</p>
<ul class="simple">
<li>array, matrix contruction</li>
<li>operator =, +=, -=, …</li>
</ul>
<p>When an array in assigned (or constructed from) such expression, it fills itself
by evaluating the expression.</p>
<p>This technique allows the elimination of temporaries, so that the clear and readable code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span><span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
<p>is in fact rewritten by the compiler into</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,...)</span> <span class="n">indices</span> <span class="n">of</span> <span class="n">A</span><span class="p">,</span> <span class="nl">B</span> <span class="p">:</span>
  <span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span> <span class="n">B</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
<p>instead of making a chain of temporaries (C/2, 2*B, 2*B + C/2…) that “ordinary” object-oriented programming would produce.
As a result, the produced code is as fast as if you were writing the loop yourself,
but with several advantages:</p>
<ul class="simple">
<li>It is more <strong>compact</strong> and <strong>readable</strong>: you don’t have to write the loop, and the indices range are computed automatically.</li>
<li>It is much better for <strong>optimization</strong>:<ul>
<li>What you want is to tell the compiler/library to compute this expression, not <em>how</em> to do it optimally on a given machine.</li>
<li>For example, since the traversal order of indices is decided at compile time, the library can traverse the data
in an optimal way, allowing machine-dependent optimization.</li>
<li>The library can perform easy optimisations behind the scene when possible, e.g. for vector it can use blas.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="expressions-are-lazy">
<h2>Expressions are lazy….<a class="headerlink" href="#expressions-are-lazy" title="Permalink to this headline">¶</a></h2>
<p>Note that expressions are lazy objects. It does nothing when constructed, it just “record” the mathematical expression</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">e</span> <span class="o">=</span>  <span class="n">A</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">B</span><span class="p">;</span>             <span class="c1">// expression, purely formal, no computation is done</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">e</span> <span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>              <span class="c1">// prints the expression</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>         <span class="c1">// evaluates just at a point</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">domain</span><span class="p">()</span> <span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>     <span class="c1">// just computes its domain</span>
<span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">D</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>            <span class="c1">// now really makes the computation and store the result in D.</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">A</span> <span class="o">+</span><span class="n">B</span><span class="p">;</span>                    <span class="c1">// reassign D to the evaluation of the expression.</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="play_with_concept.html" title="Using basic concepts"
             >next</a> |</li>
        <li class="right" >
          <a href="map.html" title="Functional constructs: map &amp; fold"
             >previous</a> |</li>
    <li><a href="../../../../index.html">Home</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../../../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../contents.html" >&lt;no title&gt;</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="contents.html" ><strong>[triqs/arrays]</strong> Multidimensional arrays</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2017, The TRIQS collaboration.
    </div>
  </body>
</html>