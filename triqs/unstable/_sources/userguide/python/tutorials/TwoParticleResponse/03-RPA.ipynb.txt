{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# The random phase approximation (RPA)\n",
    "\n",
    "\n",
    "The Lindhard susceptibility $\\chi_0$ is the exact susceptibility for the non-interacting case $U=0$, however for finite interactions the susceptibility of the system $\\chi$ is given by the Bethe-Salpeter equation\n",
    "\n",
    "$$ \\chi = \\chi_0 + \\chi_0 \\Gamma \\chi $$\n",
    "\n",
    "where $\\Gamma$ is the particle-hole irreducible vertex function, containing all diagrams with insertions of the interaction that can not be separated by cutting a pair of particle-hole single-particle propagators $G G$.\n",
    "\n",
    "The first order contribution to the vertex $\\Gamma$ is the bare interaction $U$ and the approximation\n",
    "\n",
    "$$ \\Gamma = U/2 $$\n",
    "\n",
    "gives the so-called random phase approximation for $\\chi$, i.e.\n",
    "\n",
    "$$ \\chi_{RPA} = \\chi_0 + \\chi_0 \\frac{U}{2} \\chi_{RPA} $$\n",
    "\n",
    "Rewriting this equation gives $\\chi_{RPA}$ as\n",
    "\n",
    "$$ \\chi_{RPA} = \\frac{\\chi_0}{1 - \\frac{U}{2} \\chi_0} $$\n",
    "\n",
    "note that the denominator of this equation can in general go to zero, whereby the susceptibility $\\chi_{RPA}$ diverges. Whence the RPA approximation can be used to compute instabilities of the system towards, e.g., anti-ferromagnetic symmetry breaking.\n",
    "\n",
    "As an example we compute $\\chi_{RPA}$ for the square lattice and the enhancement of the $\\mathbf{q} = (\\pi, \\pi)$ peak as a function of $U$.\n",
    "\n",
    "RPA predicts a phase transition to an antiferromagnetic state at *finite temperatures*. In two dimensions this is unphysical since the Mermin Wagner theorem tells us that the phase transition only occurs at zero temperature. \n",
    "\n",
    "We will later see how to remedy this shortcoming of RPA using the TPSC approach."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-06-22T22:56:00.132304Z",
     "iopub.status.busy": "2022-06-22T22:56:00.131129Z",
     "iopub.status.idle": "2022-06-22T22:56:03.458439Z",
     "shell.execute_reply": "2022-06-22T22:56:03.456077Z"
    }
   },
   "outputs": [],
   "source": [
    "# Imports \n",
    "from triqs.lattice import BravaisLattice, BrillouinZone\n",
    "from triqs.gf import MeshBrZone, MeshImFreq, Gf, MeshProduct\n",
    "from h5 import HDFArchive\n",
    "from triqs.plot.mpl_interface import plt, oplot\n",
    "plt.rcParams[\"figure.dpi\"] = 100 # make figures bigger\n",
    "%matplotlib inline\n",
    "import numpy as np\n",
    "from math import cos, pi"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-06-22T22:56:03.473382Z",
     "iopub.status.busy": "2022-06-22T22:56:03.472193Z",
     "iopub.status.idle": "2022-06-22T22:56:05.858592Z",
     "shell.execute_reply": "2022-06-22T22:56:05.855416Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Cannot open the HDF file tpsc.h5\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "HDF5-DIAG: Error detected in HDF5 (1.12.2) thread 0:\n",
      "  #000: H5F.c line 620 in H5Fopen(): unable to open file\n",
      "    major: File accessibility\n",
      "    minor: Unable to open file\n",
      "  #001: H5VLcallback.c line 3502 in H5VL_file_open(): failed to iterate over available VOL connector plugins\n",
      "    major: Virtual Object Layer\n",
      "    minor: Iteration failed\n",
      "  #002: H5PLpath.c line 579 in H5PL__path_table_iterate(): can't iterate over plugins in plugin path '(null)'\n",
      "    major: Plugin for dynamically loaded library\n",
      "    minor: Iteration failed\n",
      "  #003: H5PLpath.c line 620 in H5PL__path_table_iterate_process_path(): can't open directory: /usr/local/hdf5/lib/plugin\n",
      "    major: Plugin for dynamically loaded library\n",
      "    minor: Can't open directory or file\n",
      "  #004: H5VLcallback.c line 3351 in H5VL__file_open(): open failed\n",
      "    major: Virtual Object Layer\n",
      "    minor: Can't open object\n",
      "  #005: H5VLnative_file.c line 97 in H5VL__native_file_open(): unable to open file\n",
      "    major: File accessibility\n",
      "    minor: Unable to open file\n",
      "  #006: H5Fint.c line 1835 in H5F_open(): unable to open file: name = 'tpsc.h5', tent_flags = 0\n",
      "    major: File accessibility\n",
      "    minor: Unable to open file\n",
      "  #007: H5FD.c line 723 in H5FD_open(): open failed\n",
      "    major: Virtual File Layer\n",
      "    minor: Unable to initialize object\n",
      "  #008: H5FDsec2.c line 355 in H5FD__sec2_open(): unable to open file: name = 'tpsc.h5', errno = 2, error message = 'No such file or directory', flags = 0, o_flags = 0\n",
      "    major: File accessibility\n",
      "    minor: Unable to open file\n"
     ]
    },
    {
     "ename": "RuntimeError",
     "evalue": ".. Error occurred at Wed Jun 22 18:56:03 2022\n\n.. Error .. in calling C++ overload of constructor :\n.. (no C++ name)(std::string name, char mode) -> \n.. C++ error was : \nHDF5 : cannot openfile : tpsc.h5",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mRuntimeError\u001b[0m                              Traceback (most recent call last)",
      "Input \u001b[0;32mIn [2]\u001b[0m, in \u001b[0;36m<cell line: 2>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      1\u001b[0m \u001b[38;5;66;03m# Reload the previous result\u001b[39;00m\n\u001b[0;32m----> 2\u001b[0m \u001b[38;5;28;01mwith\u001b[39;00m \u001b[43mHDFArchive\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;124;43mtpsc.h5\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43mr\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m)\u001b[49m \u001b[38;5;28;01mas\u001b[39;00m R:\n\u001b[1;32m      3\u001b[0m     chi0_qw \u001b[38;5;241m=\u001b[39m R[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mchi0_qw\u001b[39m\u001b[38;5;124m'\u001b[39m]\n",
      "File \u001b[0;32m~/opt/triqs/lib/python3.9/site-packages/h5/archive.py:383\u001b[0m, in \u001b[0;36mHDFArchive.__init__\u001b[0;34m(self, descriptor, open_flag, key_as_string_only, reconstruct_python_object, init)\u001b[0m\n\u001b[1;32m    380\u001b[0m         \u001b[38;5;28;01mtry\u001b[39;00m: os\u001b[38;5;241m.\u001b[39mremove(os\u001b[38;5;241m.\u001b[39mpath\u001b[38;5;241m.\u001b[39mabspath(LocalFileName))\n\u001b[1;32m    381\u001b[0m         \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mOSError\u001b[39;00m: \u001b[38;5;28;01mpass\u001b[39;00m\n\u001b[0;32m--> 383\u001b[0m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_init_root\u001b[49m\u001b[43m(\u001b[49m\u001b[43mLocalFileName\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mopen_flag\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    385\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39moptions \u001b[38;5;241m=\u001b[39m {\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mkey_as_string_only\u001b[39m\u001b[38;5;124m'\u001b[39m : key_as_string_only,\n\u001b[1;32m    386\u001b[0m                 \u001b[38;5;124m'\u001b[39m\u001b[38;5;124mdo_not_overwrite_entries\u001b[39m\u001b[38;5;124m'\u001b[39m : \u001b[38;5;28;01mFalse\u001b[39;00m,\n\u001b[1;32m    387\u001b[0m                 \u001b[38;5;124m'\u001b[39m\u001b[38;5;124mreconstruct_python_object\u001b[39m\u001b[38;5;124m'\u001b[39m: reconstruct_python_object,\n\u001b[1;32m    388\u001b[0m                 \u001b[38;5;124m'\u001b[39m\u001b[38;5;124mUseAlpsNotationForComplex\u001b[39m\u001b[38;5;124m'\u001b[39m  : \u001b[38;5;28;01mTrue\u001b[39;00m\n\u001b[1;32m    389\u001b[0m                 }\n\u001b[1;32m    390\u001b[0m HDFArchiveGroup\u001b[38;5;241m.\u001b[39m\u001b[38;5;21m__init__\u001b[39m(\u001b[38;5;28mself\u001b[39m,\u001b[38;5;28mself\u001b[39m,\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n",
      "File \u001b[0;32m~/opt/triqs/lib/python3.9/site-packages/h5/archive_basic_layer.py:46\u001b[0m, in \u001b[0;36mHDFArchiveGroupBasicLayer._init_root\u001b[0;34m(self, descriptor, open_flag)\u001b[0m\n\u001b[1;32m     44\u001b[0m \u001b[38;5;28;01massert\u001b[39;00m(\u001b[38;5;28misinstance\u001b[39m(descriptor, \u001b[38;5;28mstr\u001b[39m))\n\u001b[1;32m     45\u001b[0m \u001b[38;5;28;01mtry\u001b[39;00m :\n\u001b[0;32m---> 46\u001b[0m     fich \u001b[38;5;241m=\u001b[39m \u001b[43mh5\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mFile\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdescriptor\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mopen_flag\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m     47\u001b[0m \u001b[38;5;28;01mexcept\u001b[39;00m :\n\u001b[1;32m     48\u001b[0m     \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mCannot open the HDF file \u001b[39m\u001b[38;5;132;01m%s\u001b[39;00m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;241m%\u001b[39mdescriptor)\n",
      "\u001b[0;31mRuntimeError\u001b[0m: .. Error occurred at Wed Jun 22 18:56:03 2022\n\n.. Error .. in calling C++ overload of constructor :\n.. (no C++ name)(std::string name, char mode) -> \n.. C++ error was : \nHDF5 : cannot openfile : tpsc.h5"
     ]
    }
   ],
   "source": [
    "# Reload the previous result\n",
    "with HDFArchive(\"tpsc.h5\",'r') as R:\n",
    "    chi0_qw = R['chi0_qw']"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### <i class=\"fa fa-gear fa-x\" style=\"color: #186391\"></i> Exercise 1 \n",
    "\n",
    "Using the same code at for non-interacting susceptibility\n",
    "(Cf 02s-Lindhard), plot the RPA susceptibility\n",
    "for $U = 2.7$ as a color plot (and 3d plot).\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### <i class=\"fa fa-gear fa-x\" style=\"color: #186391\"></i> Exercise 2: Plot along some path for different values of $U$\n",
    "\n",
    "Using the same code as for non-interacting susceptibility\n",
    "(Cf 02s-Lindhard), plot $\\chi_{RPA}$ \n",
    "for various values of $U$  (e.g. in `np.arange(1., 2.8, 0.2)`)\n",
    "along the path\n",
    "in the Brillouin Zone: $\\Gamma \\rightarrow X \\rightarrow M \\rightarrow \\Gamma$\n",
    "where $\\Gamma = (0,  0 , 0)$, $X = (\\pi, \\pi, 0)$ and  $M = (\\pi, 0,  0)$."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### <i class=\"fa fa-gear fa-x\" style=\"color: #186391\"></i> Exercise 3:  Critical $U$\n",
    "\n",
    "At some critical $U_c$ the RPA susceptibility diverges $\\chi_{RPA} \\rightarrow \\infty$. To determine $U_c$ we can study the root of the inverse susceptibility $\\chi_{RPA}^{-1}$.\n",
    "\n",
    "For the square lattice it is sufficient to study the response at $\\mathbf{Q}_{AF}= (\\pi, \\pi)$ since this is the momentum vector where the response diverges. Analytically this occurs when the denominator is zero $1 - \\frac{U}{2} \\chi(\\mathbf{Q}_{AF}, 0) = 0$, i.e.\n",
    "\n",
    "$$ U_c^{(RPA)} = \\frac{2}{\\chi(\\mathbf{Q}_{AF}, 0)} $$\n",
    "\n",
    "Plot $\\chi_{RPA}^{-1} (\\mathbf{Q}_{AF}, 0)$ vs $U$ to numerically determine the critical $U$ in the RPA approximation and compare to a direct calculation of $U_c^{(RPA)}$.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
