
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interface with VASP &#8212; triqs_dft_tools  documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/triqs.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=default"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
    <script src="../_static/cufon-yui.js" type="text/javascript"></script>
    <script src="../_static/spaceman.cufonfonts.js" type="text/javascript"></script>
    <script type="text/javascript">
      Cufon.replace('.triqs', { fontFamily: 'spaceman', hover: true }); 
    </script>
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>

  </head><body>
<div class="pageheader">
  <ul>
    
    <li><a href="../install.html">Install</a></li>
    
    <li><a href="../documentation.html">Documentation</a></li>
    
    <li><a href="../tutorials.html">Tutorials</a></li>
    
    <li><a href="../issues.html">Issues</a></li>
    
    <li><a href="../about.html">About DFTTools</a></li>
    
  </ul>
  <div>
    <h1 style="padding:0; margin: 10px 0 0 0;"><a class="triqs" href="../index.html">dft tools</a></h1>
    <span style="font-size: 14px; margin: 0px; padding: 0px;">connecting <a class="triqs" style="font-size: 12px" href="http://triqs.github.io/triqs">TRIQS</a> to DFT packages</span>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../index.html">Home</a> &raquo;</li>

        <li class="nav-item nav-item-this"><a href="">Interface with VASP</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Interface with VASP</a><ul>
<li><a class="reference internal" href="#limitations-of-the-interface">Limitations of the interface</a></li>
<li><a class="reference internal" href="#vasp-generating-raw-projectors">VASP: generating raw projectors</a><ul>
<li><a class="reference internal" href="#vasp-input-output">VASP input-output</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conversion-for-the-dmft-self-consistency-cycle">Conversion for the DMFT self-consistency cycle</a><ul>
<li><a class="reference internal" href="#plovasp-converting-vasp-output">PLOVASP: converting VASP output</a></li>
<li><a class="reference internal" href="#running-the-vasp-converter">Running the VASP converter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plovasp-detailed-guide">PLOVASP detailed guide</a><ul>
<li><a class="reference internal" href="#input-file-format">Input file format</a><ul>
<li><a class="reference internal" href="#section-general">Section [General]</a></li>
<li><a class="reference internal" href="#section-shell">Section [Shell]</a></li>
<li><a class="reference internal" href="#section-group">Section [Group]</a></li>
<li><a class="reference internal" href="#file-of-transformation-matrices">File of transformation matrices</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#remarks-on-the-vasp-version">Remarks on the VASP version</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/guide/conv_vasp.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="interface-with-vasp">
<span id="convvasp"></span><h1>Interface with VASP<a class="headerlink" href="#interface-with-vasp" title="Permalink to this headline">¶</a></h1>
<p>The VASP interface relies on new options introduced since version 5.4.x In
particular, a new INCAR-option <a class="reference external" href="https://cms.mpi.univie.ac.at/wiki/index.php/LOCPROJ">LOCPROJ</a>, the new <cite>LORBIT</cite> modes
13 and 14 have been added, and the new <cite>ICHARG</cite> mode 5 for charge
self-consistent DFT+DMFT calculations have been added.</p>
<p>The VASP interface methodologically builds on the so called projection on
localized orbitals (PLO) scheme, where the resulting KS states from DFT are
projected on localized orbitals, which defines a basis for setting up a
Hubbard-like model Hamiltonian. Resulting in lattice object stored in <cite>SumkDFT</cite>.
The implementation is presented in <a class="reference external" href="https://doi.org/10.1088/1361-648X/aae80a">M. Schüler et al. 2018 J. Phys.: Condens.
Matter 30 475901</a>.</p>
<p>The interface consists of two parts, <a class="reference internal" href="../reference/converters.html#refplovasp"><span class="std std-ref">PLOVASP</span></a>, a collection of
python classes and functions converting the raw VASP output to proper projector
functions, and the python based <a class="reference internal" href="../reference/converters.html#refvaspconverter"><span class="std std-ref">VaspConverter</span></a>, which
creates a h5 archive from the <a class="reference internal" href="../reference/converters.html#refplovasp"><span class="std std-ref">PLOVASP</span></a> output readable by
<cite>SumkDFT</cite>. Therefore, the conversion consist always of two steps.</p>
<p>Here, we will present a guide how the interface <cite>can</cite> be used to create input for a DMFT calculation, using SrVO3 as an example. Full examples can be found in the <a class="reference internal" href="../tutorials.html#tutorials"><span class="std std-ref">tutorial section of DFTTools</span></a>.</p>
<div class="section" id="limitations-of-the-interface">
<h2>Limitations of the interface<a class="headerlink" href="#limitations-of-the-interface" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The interface works correctly only if the k-point symmetries
are turned off during the VASP run (ISYM=-1).</p></li>
<li><p>Generation of projectors for k-point lines (option <cite>Lines</cite> in KPOINTS)
needed for Bloch spectral function calculations is not possible at the moment.</p></li>
<li><p>The interface currently supports only collinear-magnetism calculation
(this implies no spin-orbit coupling) and spin-polarized projectors have not
been tested.</p></li>
<li><p>The converter needs the correct Fermi energy from VASP, which is read from
the LOCPROJ file. However, VASP by default does not output this information.
Please see <a class="reference internal" href="#remarks-on-the-vasp-version">Remarks on the VASP version</a>.</p></li>
</ul>
</div>
<div class="section" id="vasp-generating-raw-projectors">
<h2>VASP: generating raw projectors<a class="headerlink" href="#vasp-generating-raw-projectors" title="Permalink to this headline">¶</a></h2>
<p>The VASP <strong>INCAR</strong> option <cite>LOCPROJ</cite> selects a set of localized projectors that
will be written to the file <strong>LOCPROJ</strong> after a successful VASP run. A projector set is specified by site indices, labels of the target local states, and projector type:</p>
<blockquote>
<div><div class="line-block">
<div class="line"><cite>LOCPROJ = &lt;sites&gt; : &lt;shells&gt; : &lt;projector type&gt;</cite></div>
</div>
</div></blockquote>
<p>where <cite>&lt;sites&gt;</cite> represents a list of site indices separated by spaces, with the
indices corresponding to the site position in the <strong>POSCAR</strong> file; <cite>&lt;shells&gt;</cite>
specifies local states (see below); <cite>&lt;projector type&gt;</cite> chooses a particular type
of the local basis function. The recommended projector type is <cite>Pr 2</cite>. This will
perform a projection of the Kohn-Sham states onto the VASP PAW projector
functions. The number specified behind <cite>Pr</cite> is selecting a specific PAW channel,
see the <a class="reference external" href="https://cms.mpi.univie.ac.at/wiki/index.php/LOCPROJ">VASP wiki page</a>
for more information. The formalism for this type of projectors is presented in
<a class="reference external" href="https://doi.org/10.1088/1361-648X/aae80a">M. Schüler et al. 2018 J. Phys.: Condens. Matter 30 475901</a>. For further details on the
<cite>LOCPROJ</cite> flag also have a look in the <a class="reference external" href="https://cms.mpi.univie.ac.at/wiki/index.php/LOCPROJ">VASP wiki</a>.</p>
<p>The allowed labels of the local states defined in terms of cubic
harmonics are (mind the order):</p>
<blockquote>
<div><ul class="simple">
<li><p>Entire shells: <cite>s</cite>, <cite>p</cite>, <cite>d</cite>, <cite>f</cite></p></li>
<li><p><cite>p</cite>-states: <cite>py</cite>, <cite>pz</cite>, <cite>px</cite></p></li>
<li><p><cite>d</cite>-states: <cite>dxy</cite>, <cite>dyz</cite>, <cite>dz2</cite>, <cite>dxz</cite>, <cite>dx2-y2</cite></p></li>
<li><p><cite>f</cite>-states: <cite>fy(3x2-y2)</cite>, <cite>fxyz</cite>, <cite>fyz2</cite>, <cite>fz3</cite>,
<cite>fxz2</cite>, <cite>fz(x2-y2)</cite>, <cite>fx(x2-3y2)</cite>.</p></li>
</ul>
</div></blockquote>
<p>For projector type <cite>Pr</cite>, one should ideally also set <cite>LORBIT = 14</cite> in the
INCAR file and provide parameters <cite>EMIN</cite>, <cite>EMAX</cite>, defining, in this case, an
energy range (energy window) corresponding to the valence states. Note that,
as in the case of a DOS calculation, the position of the valence states
depends on the Fermi level, which can usually be found at the end of the
OUTCAR file. Setting <cite>LORBIT=14</cite> will perform an automatic optimization of
the PAW projector channel as described in <a class="reference external" href="https://doi.org/10.1088/1361-648X/aae80a">M. Schüler et al. 2018 J. Phys.:
Condens. Matter 30 475901</a>, by
using a linear combination of the PAW channels, to maximize the overlap in
the chosen energy window between the projector and the Kohn-Sham state.
Therefore, setting <cite>LORBIT=14</cite> will let VASP ignore the channel specified
after <cite>Pr</cite>. This optimization is only performed for the projector type <cite>Pr</cite>,
not for <cite>Ps</cite> and obviously not for <cite>Hy</cite>. We recommend to specify the PAW
channel anyway, in case one forgets to set <cite>LORBIT=14</cite>.</p>
<p>In case of SrVO3 one may first want to perform a self-consistent
calculation to know the Fermi level and the rough position of the target states.
In the next step one sets <cite>ICHARG = 1</cite> and adds the following additional lines
into INCAR (provided that V is the second ion in POSCAR):</p>
<blockquote>
<div><div class="line-block">
<div class="line"><cite>EMIN = 3.0</cite></div>
<div class="line"><cite>EMAX = 8.0</cite></div>
<div class="line"><cite>LORBIT = 14</cite></div>
<div class="line"><cite>LOCPROJ = 2 : d : Pr 2</cite></div>
</div>
</div></blockquote>
<p>The energy range does not have to be precise. Important is that it has a large
overlap with valence bands and no overlap with semi-core or high unoccupied
states. This <strong>INCAR</strong> will calculate and write-out projections for all five d-orbitals.</p>
<div class="section" id="vasp-input-output">
<h3>VASP input-output<a class="headerlink" href="#vasp-input-output" title="Permalink to this headline">¶</a></h3>
<p>The calculated projections <span class="math notranslate nohighlight">\(\langle \chi_L | \Psi_\mu \rangle\)</span> are written
into files <strong>PROJCAR</strong> and <strong>LOCPROJ</strong>. The difference between these two files
is that <strong>LOCPROJ</strong> contains raw matrices without any reference to
sites/orbitals, while <strong>PROJCAR</strong> is more detailed. In particular, the
information that can be obtained for each projector from <strong>PROJCAR</strong> is the
following:</p>
<blockquote>
<div><ul class="simple">
<li><p>site (and species) index</p></li>
<li><p>for each <cite>k</cite>-point and band: a set of complex numbers for labeled orbitals</p></li>
</ul>
</div></blockquote>
<p>At the same time, <strong>LOCPROJ</strong> contains the total number of projectors (as well
as the number of <cite>k</cite>-points, bands, and spin channels) in the first line, which
can be used to allocate the arrays before parsing.</p>
</div>
</div>
<div class="section" id="conversion-for-the-dmft-self-consistency-cycle">
<h2>Conversion for the DMFT self-consistency cycle<a class="headerlink" href="#conversion-for-the-dmft-self-consistency-cycle" title="Permalink to this headline">¶</a></h2>
<p>The projectors generated by VASP require certain post-processing before they can
be used for DMFT calculations. The most important step is to (ortho-)normalize
them within an energy window that selects band states relevant for the impurity
problem. This will create proper Wannier functions of the initial projections
produced by VASP. Note that this energy window is different from the one
described above and it must be chosen independently of the energy range given by
<cite>EMIN, EMAX</cite> in the <strong>INCAR</strong> VASP input file. This part is done in <cite>PLOVASP</cite>.</p>
<div class="section" id="plovasp-converting-vasp-output">
<h3>PLOVASP: converting VASP output<a class="headerlink" href="#plovasp-converting-vasp-output" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../reference/converters.html#refplovasp"><span class="std std-ref">PLOVASP</span></a> is a collection of python functions and classes, post-processing the raw VASP <cite>LOCPROJ</cite> output creating proper projector functions.</p>
<dl class="simple">
<dt>The following VASP files are used by PLOVASP:</dt><dd><ul class="simple">
<li><p>PROJCAR, LOCPROJ: raw projectors generated by VASP-PLO interface</p></li>
<li><p>EIGENVAL: Kohn-Sham eigenvalues as well as <cite>k</cite>-points with weights and Fermi weights</p></li>
<li><p>IBZKPT: <cite>k</cite>-point data (<span class="math notranslate nohighlight">\(\Gamma\)</span>)</p></li>
<li><p>POSCAR: crystal structure data</p></li>
</ul>
</dd>
</dl>
<p>To run <cite>PLOVASP</cite>, one first prepares an input file <cite>&lt;name&gt;.cfg</cite> (default name <cite>plo.cfg</cite>) that describes the definition of the correlated subspace. For SrVO3 this input file would look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">General</span><span class="p">]</span>
<span class="n">DOSMESH</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span> <span class="mf">3.0</span> <span class="mi">2001</span>

<span class="p">[</span><span class="n">Shell</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">LSHELL</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">IONS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">EWINDOW</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.4</span> <span class="mf">2.0</span>

<span class="n">TRANSFORM</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>
            <span class="mf">0.0</span>  <span class="mf">1.0</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>
            <span class="mf">0.0</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>  <span class="mf">1.0</span>  <span class="mf">0.0</span>
</pre></div>
</div>
<p>In the [section] general, the <cite>DOSMESH</cite> defines an energy window and number of
data points, which lets the converter calculate the density of states of the
created projector functions in a given energy window. Each projector shell is
defined by a section <cite>[Shell 1]</cite> where the number can be arbitrary and used only
for user convenience. Several parameters are required</p>
<ul class="simple">
<li><p><strong>IONS</strong>: list of site indices which must be a subset of indices given earlier
in the VASP INCAR <cite>LOCPROJ</cite> flag. Note: If projections are performed for
multiple sites one can specify symmetry equivalent sites with brackets: <cite>[2
3]</cite>. Here the projector are generated for ions 2 and 3, but they will be
marked as symmetry equivalent later in ‘SumkDFT’.</p></li>
<li><p><strong>LSHELL</strong>: <span class="math notranslate nohighlight">\(l\)</span>-quantum number of the projector shell; the corresponding
orbitals must be present in <cite>LOCPROJ</cite>.</p></li>
<li><p><strong>EWINDOW</strong>: energy window in which the projectors are normalized;
note that the energies are defined with respect to the Fermi level.</p></li>
</ul>
<p>The Option <strong>TRANSFORM</strong> is optional here, and it is specified to extract
only the three <span class="math notranslate nohighlight">\(t_{2g}\)</span> orbitals out of the five <cite>d</cite> orbitals given by
<span class="math notranslate nohighlight">\(l = 2\)</span>. A detailed explanation of all input parameters can be found
further below <a class="reference internal" href="#plovasp-detailed-guide">PLOVASP detailed guide</a>.</p>
<dl>
<dt>Next, the converter is executed. This can be done by calling <strong class="program">PLOVASP</strong> directly in the command line with the input file as an argument, e.g.:</dt><dd><div class="line-block">
<div class="line"><cite>plovasp plo.cfg</cite></div>
</div>
</dd>
</dl>
<p>or embedded in a python script as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">triqs_dft_tools.converters.plovasp.converter</span> <span class="k">as</span> <span class="nn">plo_converter</span>
<span class="c1"># Generate and store PLOs</span>
<span class="n">plo_converter</span><span class="o">.</span><span class="n">generate_and_output_as_text</span><span class="p">(</span><span class="s1">&#39;plo.cfg&#39;</span><span class="p">,</span> <span class="n">vasp_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will create the xml files <cite>vasp.ctrl</cite> and <cite>vasp.pg1</cite> containing the orthonormalized projector functions readable by the <a class="reference internal" href="../reference/converters.html#refvaspconverter"><span class="std std-ref">VaspConverter</span></a>. Moreover, <cite>PLOVASP</cite> will output important information of the orthonormalization process, such as the density matrix of the correlated shell and the local Hamiltonian.</p>
</div>
<div class="section" id="running-the-vasp-converter">
<h3>Running the VASP converter<a class="headerlink" href="#running-the-vasp-converter" title="Permalink to this headline">¶</a></h3>
<p>The actual conversion to a h5-file is performed with the orthonormalized projector functions readable by the <a class="reference internal" href="../reference/converters.html#refvaspconverter"><span class="std std-ref">VaspConverter</span></a> in the same fashion as with the other <cite>DFTTools</cite> converters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">triqs_dft_tools.converters.vasp</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">Converter</span> <span class="o">=</span> <span class="n">VaspConverter</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;vasp&#39;</span><span class="p">)</span>
<span class="n">Converter</span><span class="o">.</span><span class="n">convert_dft_input</span><span class="p">()</span>
</pre></div>
</div>
<dl class="simple">
<dt>As usual, the resulting h5-file can then be used with the SumkDFT class::</dt><dd><p>sk = SumkDFTTools(hdf_file=’vasp.h5’)</p>
</dd>
</dl>
<p>Note that the automatic detection of the correct block structure might fail for
VASP inputs. This can be circumvented by setting a bigger value of the threshold
in <code class="xref py py-class docutils literal notranslate"><span class="pre">SumkDFT</span></code>, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SK</span><span class="o">.</span><span class="n">analyse_block_structure</span><span class="p">(</span><span class="n">threshold</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
<p>However, this should only be done after a careful study of the density matrix and the projected DOS in the localized basis. For the complete process for SrVO3 see the tutorial for the VASP interface <a class="reference external" href="../tutorials/svo_vasp/svo_notebook.html">here</a>.</p>
</div>
</div>
<div class="section" id="plovasp-detailed-guide">
<h2>PLOVASP detailed guide<a class="headerlink" href="#plovasp-detailed-guide" title="Permalink to this headline">¶</a></h2>
<p>The general purpose of the PLOVASP tool is to transform raw, non-normalized
projectors generated by VASP into normalized projectors corresponding to
user-defined projected localized orbitals (PLO). To enhance the performance
parsing the raw VASP output files, the parser is implemented in plain C. The
idea is that the python part of the parser first reads the first line of
<strong>LOCPROJ</strong> and then calls the C-routine with necessary parameters to parse
<strong>PROJCAR</strong>. The resulting PLOs can then be used for DFT+DMFT calculations with
or without charge self-consistency. PLOVASP also provides some utilities for
basic analysis of the generated projectors, such as outputting density matrices,
local Hamiltonians, and projected density of states.</p>
<p>PLOs are determined by the energy window in which the raw projectors are
normalized. This allows to define either atomic-like strongly localized Wannier
functions (large energy window) or extended Wannier functions focusing on
selected low-energy states (small energy window).</p>
<p>In PLOVASP, all projectors sharing the same energy window are combined into a
<cite>projector group</cite>. This allows one in principal to define several groups with
different energy windows for the same set of raw projectors. Note: multiple groups are not yet implemented.</p>
<p>A set of projectors defined on sites related to each other either by symmetry
or by an atomic sort, along with a set of <span class="math notranslate nohighlight">\(l\)</span>, <span class="math notranslate nohighlight">\(m\)</span> quantum numbers,
forms a <cite>projector shell</cite>. There could be several projectors shells in a
projector group, implying that they will be normalized within the same energy
window.</p>
<p>Projector shells and groups are specified by a user-defined input file whose
format is described below. Additionally, each shell can be marked correlated or non-correlated, to tell <cite>SumkDFT</cite> whether or not these should be treated in the DMFT impurity problem.</p>
<div class="section" id="input-file-format">
<h3>Input file format<a class="headerlink" href="#input-file-format" title="Permalink to this headline">¶</a></h3>
<p>The input file is written in the standard config-file format.
Parameters (or ‘options’) are grouped into sections specified as
<cite>[Section name]</cite>. All parameters must be defined inside some section.</p>
<p>A PLOVASP input file can contain three types of sections:</p>
<ol class="arabic simple">
<li><p><strong>[General]</strong>: includes parameters that are independent
of a particular projector set, such as the Fermi level, additional
output (e.g. the density of states), etc.</p></li>
<li><p><strong>[Group &lt;Ng&gt;]</strong>: describes projector groups, i.e. a set of
projectors sharing the same energy window and normalization type.
At the moment, DFTtools support only one projector group, therefore
there should be no more than one projector group.</p></li>
<li><p><strong>[Shell &lt;Ns&gt;]</strong>: contains parameters of a projector shell labelled
with <cite>&lt;Ns&gt;</cite>. If there is only one group section and one shell section,
the group section can be omitted but in this case, the group required
parameters must be provided inside the shell section.</p></li>
</ol>
<div class="section" id="section-general">
<h4>Section [General]<a class="headerlink" href="#section-general" title="Permalink to this headline">¶</a></h4>
<p>The entire section is optional and it contains four parameters:</p>
<ul class="simple">
<li><p><strong>BASENAME</strong> (string): provides a base name for output files.
Default filenames are <code class="file docutils literal notranslate"><span class="pre">vasp.*</span></code>.</p></li>
<li><p><strong>DOSMESH</strong> ([float float] integer): if this parameter is given,
the projected density of states for each projected orbital will be
evaluated and stored to files <code class="file docutils literal notranslate"><span class="pre">pdos_&lt;s&gt;_&lt;n&gt;.dat</span></code>, where <cite>s</cite> is the
shell index and <cite>n</cite> the ion index. The energy mesh is defined by three
numbers: <cite>EMIN</cite>  <cite>EMAX</cite>  <cite>NPOINTS</cite>. The first two
can be omitted in which case they are taken to be equal to the projector
energy window. <strong>Important note</strong>: at the moment this option works
only if the tetrahedron integration method (<cite>ISMEAR = -4</cite> or <cite>-5</cite>)
is used in VASP to produce <cite>LOCPROJ</cite>.</p></li>
<li><p><strong>EFERMI</strong> (float): provides the Fermi level. This value overrides
the one extracted from VASP output files.</p></li>
<li><p><strong>HK</strong> (True/False): If True, the projectors are applied the the Kohn-Sham
eigenvalues which results in a Hamitlonian H(k) in orbital basis. The H(k)
is written for each group to a file <code class="file docutils literal notranslate"><span class="pre">Basename.hk&lt;Ng&gt;</span></code>. It is recommended
to also set <cite>COMPLEMENT = True</cite> (see below). Default is False.</p></li>
</ul>
<p>There are no required parameters in this section.</p>
</div>
<div class="section" id="section-shell">
<h4>Section [Shell]<a class="headerlink" href="#section-shell" title="Permalink to this headline">¶</a></h4>
<p>This section specifies a projector shell. Each <cite>[Shell]</cite> section must be
labeled by an index, e.g. <cite>[Shell 1]</cite>. These indices can then be referenced
in a <cite>[Group]</cite> section.</p>
<p>In each <cite>[Shell]</cite> section two parameters are required:</p>
<ul class="simple">
<li><p><strong>IONS</strong> (list of integer): indices of sites included in the shell.
The sites can be given either by a list of integers <cite>IONS = 5 6 7 8</cite>
or by a range <cite>IONS = 5..8</cite>. The site indices must be compatible with
the POSCAR file. Morever, sites can be marked to be identical by
grouping them with brackets, i.e. <cite>IONS = [5 6] [7 8]</cite> will mark the
sites 5 and 6 in the POSCAR (and of course also 7 and 8) to be idential.
This will mark these correlated site as equivalent, and only one
impurity problem per bracket group is generated.</p></li>
<li><p><strong>LSHELL</strong> (integer): <span class="math notranslate nohighlight">\(l\)</span> quantum number of the desired local states.</p></li>
</ul>
<p>It is important that a given combination of site indices and local states
given by <cite>LSHELL</cite> must be present in the LOCPROJ file.</p>
<p>There are additional optional parameters that allow one to transform
the local states:</p>
<ul class="simple">
<li><p><strong>CORR</strong> (True/False): Determines if shell is correlated or not. At least one
shell has to be correlated. Default is True.</p></li>
<li><p><strong>SORT</strong> (integer): Overrides the default detection of ion sorts by supplying
an integer. Default is <cite>None</cite>, for which the default behavior is retained.</p></li>
<li><p><strong>TRANSFORM</strong> (matrix): local transformation matrix applied to all states
in the projector shell. The matrix is defined by a (multiline) block
of floats, with each line corresponding to a row. The number of columns
must be equal to <span class="math notranslate nohighlight">\(2 l + 1\)</span>, with <span class="math notranslate nohighlight">\(l\)</span> given by <cite>LSHELL</cite>. Only real matrices
are allowed. This parameter can be useful to select certain subset of
orbitals or perform a simple global rotation.</p></li>
<li><p><strong>TRANSFILE</strong> (string): name of the file containing transformation
matrices for each site. This option allows for a full-fledged functionality
when it comes to local state transformations. The format of this file
is described <a class="reference internal" href="#transformation-file"><span class="std std-ref">below</span></a>.</p></li>
</ul>
</div>
<div class="section" id="section-group">
<h4>Section [Group]<a class="headerlink" href="#section-group" title="Permalink to this headline">¶</a></h4>
<p>Each defined projector shell must be part of a projector group. In the current
implementation of DFTtools only a single group (labelled by any integer, e.g. <cite>[Group 1]</cite>)
is supported. This implies that all projector shells
must be included in this group.</p>
<p>Required parameters for any group are the following:</p>
<ul class="simple">
<li><p><strong>SHELLS</strong> (list of integers): indices of projector shells included in the group.
All defined shells must be grouped.</p></li>
<li><p><strong>EWINDOW</strong> (float float): the energy window specified by two floats: bottom
and top. All projectors in the current group are going to be normalized within
this window. <em>Note</em>: This option must be specified inside the <cite>[Shell]</cite> section
if only one shell is defined and the <cite>[Group]</cite> section is omitted.</p></li>
</ul>
<p>Optional group parameters:</p>
<ul class="simple">
<li><p><strong>NORMALIZE</strong> (True/False): specifies whether projectors in the group are
to be normalized. The default value is <strong>True</strong>.</p></li>
<li><p><strong>NORMION</strong> (True/False): specifies whether projectors are normalized on
a per-site (per-ion) basis. That is, if <cite>NORMION = True</cite>, the orthogonality
condition will be enforced on each site separately but the Wannier functions
on different sites will not be orthogonal. If <cite>NORMION = False</cite>, the Wannier functions
on different sites included in the group will be orthogonal to each other. The default value is <strong>True</strong></p></li>
<li><p><strong>BANDS</strong> (int int): the energy window specified by two ints: band index of
lowest band and band index of highest band. Using this overrides the selection
in <cite>EWINDOW</cite>.</p></li>
<li><p><strong>COMPLEMENT</strong> (True/False). If True, the orthogonal complement is calculated
resulting in unitary (quadratic) projectors, i.e., the same number of orbitals
as bands. It is required to have an equal number of bands in the energy window
at each k-point. Default is False.</p></li>
</ul>
</div>
<div class="section" id="file-of-transformation-matrices">
<span id="transformation-file"></span><h4>File of transformation matrices<a class="headerlink" href="#file-of-transformation-matrices" title="Permalink to this headline">¶</a></h4>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The description below applies only to collinear cases (i.e., without spin-orbit
coupling). In this case, the matrices are spin-independent.</p>
</div>
<p>The file specified by option <cite>TRANSFILE</cite> contains transformation matrices
for each ion.  Each line must contain a series of floats whose number is either equal to
the number of orbitals <span class="math notranslate nohighlight">\(N_{orb}\)</span> (in this case the transformation matrices
are assumed to be real) or to <span class="math notranslate nohighlight">\(2 N_{orb}\)</span> (for the complex transformation matrices).
The total number of lines <span class="math notranslate nohighlight">\(N\)</span> must be a multiple of the number of ions <span class="math notranslate nohighlight">\(N_{ion}\)</span>
and the ratio <span class="math notranslate nohighlight">\(N / N_{ion}\)</span>, then, gives the dimension of the transformed
orbital space. The lines with floats can be separated by any number of empty or
comment lines (starting from <cite>#</cite>), which are ignored.</p>
<p>A very simple example is a transformation matrix that selects the <span class="math notranslate nohighlight">\(t_{2g}\)</span> manifold.
For two correlated sites, one can define the file as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Site 1</span>
  <span class="mf">1.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>
  <span class="mf">0.0</span>   <span class="mf">1.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>
  <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">1.0</span>   <span class="mf">0.0</span>

<span class="c1"># Site 2</span>
  <span class="mf">1.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>
  <span class="mf">0.0</span>   <span class="mf">1.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>
  <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mf">1.0</span>   <span class="mf">0.0</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="remarks-on-the-vasp-version">
<h2>Remarks on the VASP version<a class="headerlink" href="#remarks-on-the-vasp-version" title="Permalink to this headline">¶</a></h2>
<p>In the current version of the interface the Fermi energy is extracted from the
DOSCAR. However, if one pursues to do charge self-consistent calculations one
needs to write the Fermi energy to the projectors (<cite>LOCPROJ</cite> file), as the DOSCAR
is only updated after a full SCF/NSCF run. The file should contain the Fermi energy
in the header. One can either copy the Fermi energy manually there after a successful
VASP run, or modify the VASP source code slightly, by replacing the following line in
<cite>locproj.F</cite> (around line 695):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span>   <span class="n">WRITE</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span><span class="s1">&#39;(4I6,&quot;  # of spin, # of k-points, # of bands, # of proj&quot; )&#39;</span><span class="p">)</span> <span class="n">NS</span><span class="p">,</span><span class="n">NK</span><span class="p">,</span><span class="n">NB</span><span class="p">,</span><span class="n">NF</span>
<span class="o">---</span>
<span class="o">&gt;</span>   <span class="n">WRITE</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span><span class="s1">&#39;(4I6,F12.7,&quot;  # of spin, # of k-points, # of bands, # of proj, Efermi&quot; )&#39;</span><span class="p">)</span> <span class="n">W</span><span class="o">%</span><span class="n">WDES</span><span class="o">%</span><span class="n">NCDIJ</span><span class="p">,</span><span class="n">NK</span><span class="p">,</span><span class="n">NB</span><span class="p">,</span><span class="n">NF</span><span class="p">,</span><span class="n">EFERMI</span>
</pre></div>
</div>
<p>Now one needs to pass additionally the variable <cite>EFERMI</cite> to the function, by changing (at arount line 560):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span>   <span class="n">SUBROUTINE</span> <span class="n">LPRJ_WRITE</span><span class="p">(</span><span class="n">IU6</span><span class="p">,</span><span class="n">IU0</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
<span class="o">---</span>
<span class="o">&gt;</span>   <span class="n">SUBROUTINE</span> <span class="n">LPRJ_WRITE</span><span class="p">(</span><span class="n">IU6</span><span class="p">,</span><span class="n">IU0</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">EFERMI</span><span class="p">)</span>
    <span class="n">REAL</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">::</span> <span class="n">EFERMI</span>
</pre></div>
</div>
<p>Next, we need to pass this option when calling from <cite>electron.F</cite> and <cite>main.F</cite>
(just search for LPRJ_WRITE in the files) and change all occurences as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span>   <span class="n">CALL</span> <span class="n">LPRJ_WRITE</span><span class="p">(</span><span class="n">IO</span><span class="o">%</span><span class="n">IU6</span><span class="p">,</span> <span class="n">IO</span><span class="o">%</span><span class="n">IU0</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<span class="o">---</span>
<span class="o">&gt;</span>   <span class="n">CALL</span> <span class="n">LPRJ_WRITE</span><span class="p">(</span><span class="n">IO</span><span class="o">%</span><span class="n">IU6</span><span class="p">,</span> <span class="n">IO</span><span class="o">%</span><span class="n">IU0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">EFERMI</span><span class="p">)</span>
</pre></div>
</div>
<p>Now Vasp should print in the header of the <cite>LOCPROJ</cite> file additionally the Fermi energy.</p>
<p>Another critical point for CSC calculations is the function call of
<cite>LPRJ_LDApU</cite> in VASP. This function is not needed, and was left there for debug
purposes, but is called every iteration. Removing the call to this function in <cite>electron.F</cite> in line 644 speeds up the calculation significantly in the <cite>ICHARG=5</cite> mode. Moreover, this prevents VASP from generating the <cite>GAMMA</cite> file, which should ideally only be done by the DMFT code after a successful DMFT step, and then be read by VASP.</p>
<p>Furthermore, there is a bug in <cite>fileio.F</cite> around line 1710 where VASP tries to
print “reading the density matrix from Gamma”. This should be done only by the
master node, and VASP gets stuck sometimes. Adding a</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IF</span> <span class="p">(</span><span class="n">IO</span><span class="o">%</span><span class="n">IU0</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span>
<span class="o">...</span>
<span class="n">ENDIF</span>
</pre></div>
</div>
<p>statement resolves this issue. A similar problem occurs, when VASP writes the
<cite>OSZICAR</cite> file and a buffer is stuck. Adding a <cite>flush</cite> to the buffer in
<cite>electron.F</cite> around line 580 after</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CALL</span> <span class="n">STOP_TIMING</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">,</span><span class="n">IO</span><span class="o">%</span><span class="n">IU6</span><span class="p">,</span><span class="s2">&quot;DOS&quot;</span><span class="p">)</span>
<span class="n">flush</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<span class="nb">print</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39; &#39;</span>
</pre></div>
</div>
<p>resolves this issue. Otherwise the OSZICAR file is not written properly.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../index.html">Home</a> &raquo;</li>

        <li class="nav-item nav-item-this"><a href="">Interface with VASP</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2020.
    </div>
  </body>
</html>