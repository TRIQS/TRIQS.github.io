

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Full charge self-consistency &mdash; TRIQS DFTTools  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Manipulating the Green’s functions block structure" href="blockstructure.html" />
    <link rel="prev" title="Single-shot DFT+DMFT" href="dftdmft_singleshot.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #7E588A" >
          

          
            <a href="../index.html" class="icon icon-home"> TRIQS DFTTools
          

          
          </a>

          
            
            
              <div class="version">
                3.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../install.html#packaged-versions-of-dfttools">Packaged Versions of DFTTools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../install.html#ubuntu-debian-packages">Ubuntu Debian packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install.html#anaconda-experimental">Anaconda (experimental)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install.html#id2">Docker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../install.html#compiling-dfttools-from-source">Compiling DFTTools from source</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../install.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install.html#installation-steps">Installation steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install.html#important-note-for-fcsc-dft-dmft-calculations">Important note for FCSC DFT+DMFT calculations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install.html#installation-steps-for-the-use-with-wien2k-version-14-2-and-older">Installation steps for the use with WIEN2K version 14.2 and older</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install.html#version-compatibility">Version compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install.html#custom-cmake-options">Custom CMake options</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../documentation.html">Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../documentation.html#basic-notions">Basic notions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../basicnotions/first.html">What you should know</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/first.html#what-is-dfttools">What is <strong class="program">DFTTools</strong>?</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/first.html#understand-the-philosophy-of-dfttools">Understand the philosophy of <strong class="program">DFTTools</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/first.html#learn-how-to-use-triqs-and-the-cthyb-solver">Learn how to use <span class="xref std std-ref">TRIQS</span> (and the <span class="xref std std-ref">CTHYB</span> solver)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/first.html#analytic-continuation">Analytic Continuation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../basicnotions/dft_dmft.html">Introduction to DFT+DMFT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/dft_dmft.html#density-functional-theory-in-a-very-small-nutshell">Density-functional theory in a (very small) nutshell</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/dft_dmft.html#from-dft-to-dmft">From DFT to DMFT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/dft_dmft.html#using-projective-wannier-functions-for-dmft">Using projective Wannier functions for DMFT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/dft_dmft.html#full-charge-self-consistency">Full charge self-consistency</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../basicnotions/structure.html">Structure of <strong class="program">DFTTools</strong></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/structure.html#the-interface-layer">The interface layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/structure.html#the-dmft-calculation">The DMFT calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/structure.html#full-charge-self-consistency">Full charge self consistency</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/structure.html#post-processing">Post-processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../basicnotions/structure.html#executing-your-python-scripts">Executing your python scripts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation.html#construction-of-local-orbitals-from-dft">Construction of local orbitals from DFT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="conversion.html">Supported interfaces</a><ul>
<li class="toctree-l4"><a class="reference internal" href="conv_wien2k.html">Interface with Wien2k</a></li>
<li class="toctree-l4"><a class="reference internal" href="conv_vasp.html">Interface with VASP</a></li>
<li class="toctree-l4"><a class="reference internal" href="conv_elk.html">Interface with Elk</a></li>
<li class="toctree-l4"><a class="reference internal" href="conv_W90.html">Interface with Wannier90</a></li>
<li class="toctree-l4"><a class="reference internal" href="conv_generalhk.html">A general H(k)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="conversion.html#mpi-issues">MPI issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="conversion.html#interfaces-to-other-packages">Interfaces to other packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../h5structure.html">standardized hdf5 structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../h5structure.html#groups-and-their-formats">groups and their formats</a></li>
<li class="toctree-l4"><a class="reference internal" href="../h5structure.html#general-and-simple-h-k-converter">General and simple H(k) Converter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="../documentation.html#dft-dmft">DFT+DMFT</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="dftdmft_singleshot.html">Single-shot DFT+DMFT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="dftdmft_singleshot.html#initialization-of-the-calculation">Initialization of the calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="dftdmft_singleshot.html#setting-up-the-impurity-solver">Setting up the impurity solver</a></li>
<li class="toctree-l4"><a class="reference internal" href="dftdmft_singleshot.html#doing-the-dmft-loop">Doing the DMFT loop</a></li>
<li class="toctree-l4"><a class="reference internal" href="dftdmft_singleshot.html#restarting-a-calculation">Restarting a calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="dftdmft_singleshot.html#mixing">Mixing</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Full charge self-consistency</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#wien2k-dmftproj">Wien2k + dmftproj</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vasp-plovasp">VASP + PLOVasp</a></li>
<li class="toctree-l4"><a class="reference internal" href="#elk">Elk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#other-dft-codes">Other DFT codes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation.html#advanced-topics">Advanced Topics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="blockstructure.html">Manipulating the Green’s functions block structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="blockstructure.html#creating-a-block-structure-and-green-s-function">Creating a block structure and Green’s function</a></li>
<li class="toctree-l4"><a class="reference internal" href="blockstructure.html#the-solver-structure">The <em>solver</em> structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="blockstructure.html#picking-orbitals">Picking orbitals</a></li>
<li class="toctree-l4"><a class="reference internal" href="blockstructure.html#basis-rotations">Basis rotations</a></li>
<li class="toctree-l4"><a class="reference internal" href="blockstructure.html#diagonal-approximation">Diagonal approximation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="BasisRotation.html">Automatic basis rotations in DFT+DMFT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="BasisRotation.html#setting-up-the-initial-solver-structure-from-dft">Setting up the initial solver structure from DFT</a></li>
<li class="toctree-l4"><a class="reference internal" href="BasisRotation.html#finding-the-transformation-matrix">Finding the transformation matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="BasisRotation.html#automatic-transformation-during-the-dmft-loop">Automatic transformation during the DMFT loop</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="soc.html">Spin-orbit coupled calculations (single-shot)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="soc.html#treatment-of-soc-in-dft">Treatment of SOC in DFT</a></li>
<li class="toctree-l4"><a class="reference internal" href="soc.html#treatment-of-soc-in-wien2k">Treatment of SOC in Wien2k</a></li>
<li class="toctree-l4"><a class="reference internal" href="soc.html#treatment-of-soc-in-elk">Treatment of SOC in Elk</a></li>
<li class="toctree-l4"><a class="reference internal" href="soc.html#after-generating-the-projectors">After generating the projectors</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation.html#postprocessing">Postprocessing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="analysis.html">Tools for analysis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="analysis.html#initialisation">Initialisation</a></li>
<li class="toctree-l4"><a class="reference internal" href="analysis.html#density-of-states-of-the-wannier-orbitals">Density of states of the Wannier orbitals</a></li>
<li class="toctree-l4"><a class="reference internal" href="analysis.html#partial-charges">Partial charges</a></li>
<li class="toctree-l4"><a class="reference internal" href="analysis.html#correlated-spectral-function-with-real-frequency-self-energy">Correlated spectral function (with real-frequency self energy)</a></li>
<li class="toctree-l4"><a class="reference internal" href="analysis.html#momentum-resolved-spectral-function-with-real-frequency-self-energy">Momentum resolved spectral function (with real-frequency self energy)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="transport.html">Transport calculations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="transport.html#formalism">Formalism</a></li>
<li class="toctree-l4"><a class="reference internal" href="transport.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="transport.html#wien2k-optics-package">Wien2k optics package</a></li>
<li class="toctree-l4"><a class="reference internal" href="transport.html#using-the-transport-code">Using the transport code</a></li>
<li class="toctree-l4"><a class="reference internal" href="transport.html#references">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation.html#reference-manual">Reference manual</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../_python_api/triqs_dft_tools.block_structure.html">block_structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.block_structure.BlockStructure.html">triqs_dft_tools.block_structure.BlockStructure</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.html">converters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.converter_tools.html">converter_tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.elk.html">elk</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.elktools.html">elktools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.hk.html">hk</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.plovasp.html">plovasp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.vasp.html">vasp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.wannier90.html">wannier90</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.converters.wien2k.html">wien2k</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../_python_api/triqs_dft_tools.sumk_dft.html">sumk_dft</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.sumk_dft.SumkDFT.html">triqs_dft_tools.sumk_dft.SumkDFT</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../_python_api/triqs_dft_tools.sumk_dft_tools.html">sumk_dft_tools</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.sumk_dft_tools.SumkDFTTools.html">triqs_dft_tools.sumk_dft_tools.SumkDFTTools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../_python_api/triqs_dft_tools.symmetry.html">symmetry</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.symmetry.Symmetry.html">triqs_dft_tools.symmetry.Symmetry</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../_python_api/triqs_dft_tools.trans_basis.html">trans_basis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../_python_api/triqs_dft_tools.trans_basis.TransBasis.html">triqs_dft_tools.trans_basis.TransBasis</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation.html#faqs">FAQs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../faqs/faqs.html">Frequently-Asked Questions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../faqs/faqs.html#wien2k-fermi-error-when-running-x-lapw2-almd-band">wien2k: FERMI ERROR when running <cite>x lapw2 -almd -band</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../faqs/faqs.html#how-do-i-plot-the-output-of-spaghettis">How do I plot the output of <cite>spaghettis</cite>?</a></li>
<li class="toctree-l4"><a class="reference internal" href="../faqs/faqs.html#x-optic-does-not-write-a-case-pmat-file">x optic does not write a case.pmat file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../faqs/faqs.html#how-do-i-get-real-frequency-quantities">How do I get real-frequency quantities?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#a-simple-example-srvo3">A simple example: SrVO3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/srvo3.html">DFT (Wien2k) and Wannier orbitals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/srvo3.html#dft-setup">DFT setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/srvo3.html#wannier-orbitals">Wannier orbitals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/srvo3.html#the-dmft-calculation">The DMFT calculation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/srvo3.html#loading-modules">Loading modules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/srvo3.html#initializing-sumkdft">Initializing SumkDFT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/srvo3.html#initializing-the-solver">Initializing the solver</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/srvo3.html#dmft-cycle">DMFT cycle</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/srvo3.html#tail-fit-parameters">Tail fit parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#basis-rotations-sr2mgoso6-without-soc">Basis rotations: Sr2MgOsO6 without SOC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/sr2mgoso6_nosoc.html">DFT (Wien2k) and Wannier orbitals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_nosoc.html#dft-setup">DFT setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_nosoc.html#wannier-orbitals">Wannier orbitals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/sr2mgoso6_nosoc.html#the-dmft-calculation">The DMFT calculation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_nosoc.html#rotating-the-basis">Rotating the basis</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_nosoc.html#the-interaction-hamiltonian">The interaction Hamiltonian</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_nosoc.html#the-dmft-loop-with-automatic-basis-rotations">The DMFT loop with automatic basis rotations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#sr2mgoso6-with-soc-non-magnetic">Sr2MgOsO6 with SOC (non-magnetic)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/sr2mgoso6_soc.html">DFT (Wien2k) and Wannier orbitals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_soc.html#dft-setup">DFT setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_soc.html#wannier-orbitals">Wannier orbitals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/sr2mgoso6_soc.html#the-dmft-calculation">The DMFT calculation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_soc.html#rotating-the-basis">Rotating the basis</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_soc.html#the-interaction-hamiltonian">The interaction Hamiltonian</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/sr2mgoso6_soc.html#the-dmft-loop-with-automatic-basis-rotations">The DMFT loop with automatic basis rotations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#full-charge-self-consistency-with-wien2k-gamma-ce">Full charge self consistency with Wien2k: <span class="math notranslate nohighlight">\(\gamma\)</span>-Ce</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/ce-gamma-fscs_wien2k.html">DFT+DMFT tutorial: Ce with Hubbard-I approximation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/ce-gamma-fscs_wien2k.html#wien2k-setup">Wien2k setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/ce-gamma-fscs_wien2k.html#wannier-orbitals-dmftproj">Wannier orbitals: dmftproj</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/ce-gamma-fscs_wien2k.html#dmft-setup-hubbard-i-calculations-in-triqs">DMFT setup: Hubbard-I calculations in TRIQS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/ce-gamma-fscs_wien2k.html#fully-charge-self-consistent-dft-dmft-calculation">Fully charge self-consistent DFT+DMFT calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/ce-gamma-fscs_wien2k.html#post-processing-and-data-analysis">Post-processing and data analysis</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#vasp-interface-examples">VASP interface examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials.html#simple-converter-example-srvo3">Simple Converter example: SrVO3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/svo_vasp/svo_notebook.html">VASP setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/svo_vasp/svo_notebook.html#PLOVASP">PLOVASP</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/svo_vasp/svo_notebook.html#Converting-to-hdf5-file">Converting to hdf5 file</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials.html#complex-example-nio">Complex example: NiO</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/nio_csc.html">DFT and projections</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/nio_csc.html#dmft">DMFT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/nio_csc.html#charge-self-consistent-dmft">Charge self-consistent DMFT</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#elk-interface-examples">Elk interface examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials.html#converter-example-srvo3">Converter example: SrVO3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/svo_elk/srvo3.html">Elk to TRIQS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/svo_elk/srvo3.html#the-dmft-calculation">The DMFT calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/svo_elk/srvo3.html#triqs-to-elk-fully-charge-self-consistent-dft-dmft">TRIQS to Elk (Fully Charge Self-Consistent DFT+DMFT)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ChangeLog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ChangeLog.html#version-3-1-0">Version 3.1.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#wannier90-converter">Wannier90 Converter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#change-in-gf-struct">Change in gf_struct</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#documentation">Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#cmake">Cmake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#other-changes">Other changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ChangeLog.html#version-3-0-0">Version 3.0.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#restructuring">Restructuring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#dependency-management">Dependency Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ChangeLog.html#id2">Other Changes:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ChangeLog.html#version-2-2-1">Version 2.2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ChangeLog.html#version-2-2-0">Version 2.2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ChangeLog.html#version-2-1-x-changes-since-1-4">Version 2.1.x (changes since 1.4)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../about.html#license">License</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#authors-quotation">Authors &amp; Quotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#disclaimer">Disclaimer</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">TRIQS DFTTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../documentation.html">Documentation</a> &raquo;</li>
        
      <li>Full charge self-consistency</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/guide/dftdmft_selfcons.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="full-charge-self-consistency">
<span id="full-charge-selfcons"></span><h1>Full charge self-consistency<a class="headerlink" href="#full-charge-self-consistency" title="Permalink to this headline">¶</a></h1>
<p>In order to do charge self-consistent calculations, we have to tell the band structure program about the
changes in the charge density due to correlation effects. The feedback of the charge density is generally
program-dependent and the procedure for running charge self-consistent calculations has to be adopted
accordingly for a given band structure program. Below we describe two implementations based on Wien2k
and VASP codes.</p>
<div class="section" id="wien2k-dmftproj">
<h2>Wien2k + dmftproj<a class="headerlink" href="#wien2k-dmftproj" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Before using this tool, you should be familiar with the band-structure package Wien2k, since
the calculation is controlled by the Wien2k scripts! Be
sure that you also understand how <strong class="program">dmftproj</strong> is used to
construct the Wannier functions. For this step, see either sections
<a class="reference internal" href="conversion.html#conversion"><span class="std std-ref">Supported interfaces</span></a>, or the extensive <a class="reference download internal" download="" href="../_downloads/e57795c2db9738fda60e3f3044f8a0c2/TutorialDmftproj.pdf"><code class="xref download docutils literal notranslate"><span class="pre">dmftproj</span> <span class="pre">manual</span></code></a>.</p>
</div>
<p>In the following, we discuss how to use the
<span class="xref std std-ref">TRIQS</span> tools in combination with the Wien2k program.</p>
<p>We can use the DMFT script as introduced in section <a class="reference internal" href="dftdmft_singleshot.html#singleshot"><span class="std std-ref">Single-shot DFT+DMFT</span></a>,
with just a few simple modifications. First, in order to be compatible with the Wien2k standards,
the DMFT script has to be named <code class="file docutils literal notranslate"><span class="pre">case.py</span></code>, where <cite>case</cite> is the place holder name of the Wien2k
calculation, see the section <a class="reference internal" href="conversion.html#conversion"><span class="std std-ref">Supported interfaces</span></a> for details. We can then set the variable <cite>dft_filename</cite> dynamically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">dft_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>This sets the <cite>dft_filename</cite> to the name of the current directory. The
remaining part of the script is identical to
that for one-shot calculations. Only at the very end we have to calculate the modified charge density,
and store it in a format such that Wien2k can read it. Therefore, after the DMFT loop that we saw in the
previous section, we symmetrise the self energy, and recalculate the impurity Green function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SK</span><span class="o">.</span><span class="n">symm_deg_gf</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span><span class="n">ish</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">S</span><span class="o">.</span><span class="n">G_iw</span> <span class="o">&lt;&lt;</span> <span class="n">inverse</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">G0_iw</span><span class="p">)</span> <span class="o">-</span> <span class="n">S</span><span class="o">.</span><span class="n">Sigma_iw</span>
<span class="n">S</span><span class="o">.</span><span class="n">G_iw</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
</pre></div>
</div>
<p>These steps are not necessary, but can help to reduce fluctuations in the total energy.
Now we calculate the modified charge density:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># find exact chemical potential</span>
<span class="n">SK</span><span class="o">.</span><span class="n">set_Sigma</span><span class="p">([</span> <span class="n">S</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="p">])</span>
<span class="n">chemical_potential</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">calc_mu</span><span class="p">(</span> <span class="n">precision</span> <span class="o">=</span> <span class="mf">0.000001</span> <span class="p">)</span>
<span class="n">dN</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">calc_density_correction</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">dft_filename</span><span class="o">+</span><span class="s1">&#39;.qdmft&#39;</span><span class="p">)</span>
<span class="n">SK</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="s1">&#39;chemical_potential&#39;</span><span class="p">,</span><span class="s1">&#39;dc_imp&#39;</span><span class="p">,</span><span class="s1">&#39;dc_energ&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>First we find the chemical potential with high precision, and after that the routine
<code class="docutils literal notranslate"><span class="pre">SK.calc_density_correction(filename)</span></code> calculates the density matrix including correlation effects. The result
is stored in the file <cite>dft_filename.qdmft</cite>, which is later read by the Wien2k program. The last statement saves
the chemical potential into the hdf5 archive.</p>
<p>We need also the correlation energy, which we evaluate by the Migdal formula:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">correnerg</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">G_iw</span> <span class="o">*</span> <span class="n">S</span><span class="o">.</span><span class="n">Sigma_iw</span><span class="p">)</span><span class="o">.</span><span class="n">total_density</span><span class="p">()</span>
</pre></div>
</div>
<p>Other ways of calculating the correlation energy are possible, for
instance a direct measurement of the expectation value of the
interacting Hamiltonian. However, the Migdal formula works always,
independent of the solver that is used to solve the impurity problem.
From this value, we subtract the double counting energy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">correnerg</span> <span class="o">-=</span> <span class="n">SK</span><span class="o">.</span><span class="n">dc_energ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>and save this value in the file, too:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">()):</span>
  <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">dft_filename</span><span class="o">+</span><span class="s1">&#39;.qdmft&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.16f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">correnerg</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The above steps are valid for a calculation with only one correlated atom in the unit cell, the most likely case
where you will apply this method. That is the reason why we give the index <cite>0</cite> in the list <cite>SK.dc_energ</cite>.
If you have more than one correlated atom in the unit cell, but all of them
are equivalent atoms, you have to multiply the <cite>correnerg</cite> by their multiplicity before writing it to the file.
The multiplicity is easily found in the main input file of the Wien2k package, i.e. <cite>case.struct</cite>. In case of
non-equivalent atoms, the correlation energy has to be calculated for
all of them separately and summed up.</p>
<p>As mentioned above, the calculation is controlled by the Wien2k scripts and not by <strong class="program">python</strong>
routines. You should think of replacing the lapw2 part of the Wien2k self-consistency cycle by</p>
<blockquote>
<div><div class="line-block">
<div class="line"><cite>lapw2 -almd</cite></div>
<div class="line"><cite>dmftproj</cite></div>
<div class="line"><cite>python case.py</cite></div>
<div class="line"><cite>lapw2 -qdmft</cite></div>
</div>
</div></blockquote>
<p>In other words, for the calculation of the density matrix in lapw2, we
add the DMFT corrections through our python scripts.
Therefore, at the command line, you start your calculation for instance by:</p>
<blockquote>
<div><cite>me&#64;home $ run -qdmft 1 -i 10</cite></div></blockquote>
<p>The flag <cite>-qdmft</cite> tells the Wien2k script that the density
matrix including correlation effects is to be read in from the
<cite>case.qdmft</cite> file, and that you want the code to run on one computing
core only. Moreover, we ask for 10 self-consistency iterations are to be
done. If you run the code on a parallel machine, you can specify the
number of nodes to be used:</p>
<blockquote>
<div><cite>me&#64;home $ run -qdmft 64 -i 10</cite></div></blockquote>
<p>In that case, you will run on 64 computing cores. As standard setting,
we use <cite>mpirun</cite> as the proper MPI execution statement. If you happen
to have a different, non-standard MPI setup, you have to give the
proper MPI execution statement, in the <cite>run_lapw</cite> script (see the
corresponding Wien2k documentation).</p>
<p>In many cases it is advisable to start from a converged one-shot
calculation. For practical purposes, you keep the number of DMFT loops
within one DFT cycle low, or even to <cite>loops=1</cite>. If you encounter
unstable convergence, you have to adjust the parameters such as
the number of DMFT loops, or some mixing of the self energy to improve
the convergence.</p>
<p>In the section <a class="reference internal" href="../tutorials/ce-gamma-fscs_wien2k.html#dftdmfttutorial"><span class="std std-ref">DFT+DMFT tutorial: Ce with Hubbard-I approximation</span></a> we will see in a detailed
example how such a self-consistent calculation is performed from scratch.</p>
</div>
<div class="section" id="vasp-plovasp">
<h2>VASP + PLOVasp<a class="headerlink" href="#vasp-plovasp" title="Permalink to this headline">¶</a></h2>
<p>Unlike Wien2k implementation the charge self-consistent DMFT cycle in the
framework of PLOVasp interface is controlled by an external script. Because of
the specific way the DFT self-consistency is implemented in VASP the latter has
to run parallel to the DMFT script, with the synchronisation being ensured by a
lock file.</p>
<p>Once VASP reaches the point where the projectors are generated
it creates a lock file <cite>vasp.lock</cite> and waits until the lock file is
removed. The shell script, in turn, waits for the VASP process and once
the lock file is created it starts a DMFT iteration. The DMFT iteration
must finish by generating a Kohn-Sham (KS) density matrix (file <cite>GAMMA</cite>)
and removing the lock file. The VASP process then reads in <cite>GAMMA</cite>
and proceeds with the next iteration. PLOVasp interface provides a shell-script <strong class="program">vasp_dmft</strong> (in the triqs bin directory):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vasp_dmft</span> <span class="p">[</span><span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">cores</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">-</span><span class="n">i</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="o">&gt;</span>  <span class="o">-</span><span class="n">j</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">VASP</span> <span class="n">iterations</span> <span class="k">with</span> <span class="n">fixed</span> <span class="n">charge</span> <span class="n">density</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">-</span><span class="n">v</span> <span class="o">&lt;</span><span class="n">VASP</span> <span class="n">version</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">p</span> <span class="o">&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">VASP</span> <span class="n">directory</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">dmft_script</span><span class="o">.</span><span class="n">py</span><span class="o">&gt;</span><span class="p">]</span>

     <span class="n">If</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">cores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">specified</span> <span class="n">it</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="mi">1</span> <span class="n">by</span> <span class="n">default</span><span class="o">.</span>
     <span class="n">Set</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">times</span> <span class="n">the</span> <span class="n">dmft</span> <span class="n">solver</span> <span class="ow">is</span> <span class="n">called</span> <span class="k">with</span> <span class="o">-</span><span class="n">i</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="o">&gt;</span>

     <span class="n">Set</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">VASP</span> <span class="n">iteration</span> <span class="k">with</span> <span class="n">a</span> <span class="n">fixed</span> <span class="n">charge</span> <span class="n">density</span> <span class="n">update</span>
     <span class="n">inbetween</span> <span class="n">the</span> <span class="n">dmft</span> <span class="n">runs</span> <span class="k">with</span> <span class="o">-</span><span class="n">j</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">VASP</span> <span class="n">iterations</span> <span class="k">with</span> <span class="n">fixed</span> <span class="n">charge</span> <span class="n">density</span><span class="o">&gt;</span>

     <span class="n">Set</span> <span class="n">the</span> <span class="n">version</span> <span class="n">of</span> <span class="n">VASP</span> <span class="n">by</span> <span class="o">-</span><span class="n">v</span> <span class="n">standard</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="o">/</span><span class="n">no_gamma_write</span> <span class="n">to</span>
     <span class="n">specify</span> <span class="k">if</span> <span class="n">VASP</span> <span class="n">writes</span> <span class="n">the</span> <span class="n">GAMMA</span> <span class="n">file</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>

     <span class="n">If</span> <span class="n">the</span> <span class="n">path</span> <span class="n">to</span> <span class="n">VASP</span> <span class="n">directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">specified</span> <span class="n">it</span> <span class="n">must</span> <span class="n">be</span> <span class="n">provided</span> <span class="n">by</span> <span class="n">a</span>
     <span class="n">variable</span> <span class="n">VASP_DIR</span><span class="o">.</span>

     <span class="o">&lt;</span><span class="n">dmft_script</span><span class="o">.</span><span class="n">py</span><span class="o">&gt;</span> <span class="n">must</span> <span class="n">provide</span> <span class="n">an</span> <span class="n">importable</span> <span class="n">function</span> <span class="s1">&#39;dmft_cycle()&#39;</span>
     <span class="n">which</span> <span class="ow">is</span> <span class="n">invoked</span> <span class="n">once</span> <span class="n">per</span> <span class="n">DFT</span><span class="o">+</span><span class="n">DMFT</span> <span class="n">iteration</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">script</span> <span class="n">name</span> <span class="ow">is</span>
     <span class="n">omitted</span> <span class="n">the</span> <span class="n">default</span> <span class="n">name</span> <span class="s1">&#39;csc_dmft.py&#39;</span> <span class="ow">is</span> <span class="n">used</span><span class="o">.</span>
</pre></div>
</div>
<p>which takes care of the process management. The user must, however, specify a path to VASP code and provide the DMFT Python-script. See for an example <a class="reference internal" href="../tutorials/nio_csc.html#nio-csc"><span class="std std-ref">NiO CSC tutorial</span></a>.</p>
<p>The user-provided script is almost the same as for Wien2k charge self-consistent
calculations with the main difference that its functionality (apart from the
lines importing other modules) should be placed inside a function <cite>dmft_cycle()</cite>
which will be called every DMFT cycle.</p>
<p>VASP has a special INCAR <cite>ICHARG=5</cite> mode, that has to be switched on to make VASP wait for the <cite>vasp.lock</cite> file, and read the updated charge density after each step. One should add the following lines to the <cite>INCAR</cite> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ICHARG</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">NELM</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">NELMIN</span> <span class="o">=</span> <span class="mi">1000</span>
</pre></div>
</div>
<p>Technically, VASP runs with <cite>ICHARG=5</cite> in a SCF mode, and adding the DMFT
changes to the DFT density in each step, so that the full DFT+DMFT charge
density is constructed in every step. This is only done in VASP because only the
changes to the DFT density are read by VASP not the full DFT+DMFT density.
Moreover, one should always start with a converged <cite>WAVECAR</cite> file, or make sure,
that the KS states are well converged before the first projectors are created!
To understand the difference please make sure to read <a class="reference external" href="https://www.vasp.at/wiki/index.php/ISTART" rel="noopener noreferrer" target="_blank">ISTART flag VASP wiki</a>. Furthermore, the flags <cite>NELM</cite> and
<cite>NELMIN</cite> ensure that VASP does not terminate after the default number of
iterations of 60.</p>
</div>
<div class="section" id="elk">
<h2>Elk<a class="headerlink" href="#elk" title="Permalink to this headline">¶</a></h2>
<p>The Elk CSC implementation is fairly similar to the Wien2k implementation. At the end of the <a class="reference internal" href="../tutorials/svo_elk/srvo3.html#srvo3-elk"><span class="std std-ref">DMFT python script</span></a>, the density matrix in Bloch space needs to be calculated along with the correlation energy. This is written to DMATDMFT.OUT. An example of this (using the Migdal correlation energy formula) is given below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#output the density matrix for Elk interface</span>
<span class="n">dN</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">calc_density_correction</span><span class="p">(</span><span class="n">dm_type</span><span class="o">=</span><span class="s1">&#39;elk&#39;</span><span class="p">)</span>
<span class="c1">#correlation energy via the Migdal formula</span>
<span class="n">correnerg</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">G_iw</span> <span class="o">*</span> <span class="n">S</span><span class="o">.</span><span class="n">Sigma_iw</span><span class="p">)</span><span class="o">.</span><span class="n">total_density</span><span class="p">()</span>
<span class="c1">#subtract the double counting energy</span>
<span class="n">correnerg</span> <span class="o">-=</span> <span class="n">SK</span><span class="o">.</span><span class="n">dc_energ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#convert to Hartree</span>
<span class="n">correnerg</span> <span class="o">=</span> <span class="n">correnerg</span><span class="o">/</span><span class="n">SK</span><span class="o">.</span><span class="n">energy_unit</span>
<span class="c1">#save the correction to energy</span>
<span class="k">if</span> <span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">()):</span>
  <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;DMATDMFT.OUT&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.16f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">correnerg</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>To read this into Elk and update the electron density, run task 808. So elk.in is amended with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">task</span>
 <span class="mi">808</span>
</pre></div>
</div>
<p>This solves the Kohn-Sham equations once with the updated electron density and outputs the new set of energy eigenvalues and wavefunctions. To start the next fully charge self-consistent DFT+DMFT cycle (FCSC), a new set of projectors need to be generated (using task 805) and the whole procedure continues until convergence. The Elk potential rms value for each FCSC DFT+DMFT cycle is given in DMFT_INFO.OUT. An extensive example for SrVO:math:<cite>_3</cite> can be found here: <a class="reference internal" href="../tutorials/svo_elk/srvo3.html#srvo3-elk"><span class="std std-ref">Elk SVO tutorial</span></a>.</p>
<p>This FCSC method should be universal irrespective to what type of ground state calculation performed. However, not all types of ground state calculations have been tested.</p>
</div>
<div class="section" id="other-dft-codes">
<h2>Other DFT codes<a class="headerlink" href="#other-dft-codes" title="Permalink to this headline">¶</a></h2>
<p>The extension to other DFT codes is straightforward. As described
here, one needs to implement the correlated density matrix to be used
for the calculation of the charge density. This implementation will of
course depend on the DFT package, and might be easy to do or a quite
involved project. The formalism, however, is straight forward.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="blockstructure.html" class="btn btn-neutral float-right" title="Manipulating the Green’s functions block structure" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dftdmft_singleshot.html" class="btn btn-neutral float-left" title="Single-shot DFT+DMFT" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2011-2021.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>