<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>dft.sumk_dft_tools &mdash; TRIQS DFTTools  documentation</title>
    
    <link rel="stylesheet" href="../../_static/triqs.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/MathJax/MathJax.js?config=default"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="top" title="TRIQS DFTTools  documentation" href="../../contents.html" />
    <link rel="up" title="Module code" href="../index.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
    <script src="../../_static/cufon-yui.js" type="text/javascript"></script>
    <script src="../../_static/spaceman.cufonfonts.js" type="text/javascript"></script>
    <script type="text/javascript">
      Cufon.replace('.triqs', { fontFamily: 'spaceman', hover: true }); 
    </script>
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>

  </head>
  <body role="document">
<div class="pageheader">
  <ul>
    
    <li><a href="../../install.html">Install</a></li>
    
    <li><a href="../../documentation.html">Documentation</a></li>
    
    <li><a href="../../issues.html">Issues</a></li>
    
    <li><a href="../../about.html">About DFTTools</a></li>
    
  </ul>
  <div>
    <h1 style="padding:0; margin: 10px 0 0 0;"><a class="triqs" href="../../index.html">dft tools</a></h1>
    <span style="font-size: 14px; margin: 0px; padding: 0px;">connecting <a class="triqs" style="font-size: 12px" href="http://triqs.ipht.cnrs.fr/1.x">TRIQS</a> to DFT packages</span>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../index.html">Home</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for dft.sumk_dft_tools</h1><div class="highlight"><pre>
<span class="c">##########################################################################</span>
<span class="c">#</span>
<span class="c"># TRIQS: a Toolbox for Research in Interacting Quantum Systems</span>
<span class="c">#</span>
<span class="c"># Copyright (C) 2011 by M. Aichhorn, L. Pourovskii, V. Vildosola</span>
<span class="c">#</span>
<span class="c"># TRIQS is free software: you can redistribute it and/or modify it under the</span>
<span class="c"># terms of the GNU General Public License as published by the Free Software</span>
<span class="c"># Foundation, either version 3 of the License, or (at your option) any later</span>
<span class="c"># version.</span>
<span class="c">#</span>
<span class="c"># TRIQS is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="c"># WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c"># FOR A PARTICULAR PURPOSE. See the GNU General Public License for more</span>
<span class="c"># details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License along with</span>
<span class="c"># TRIQS. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">#</span>
<span class="c">##########################################################################</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pytriqs.gf.local</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pytriqs.utility.mpi</span> <span class="kn">as</span> <span class="nn">mpi</span>
<span class="kn">from</span> <span class="nn">symmetry</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sumk_dft</span> <span class="kn">import</span> <span class="n">SumkDFT</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="SumkDFTTools"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools">[docs]</a><span class="k">class</span> <span class="nc">SumkDFTTools</span><span class="p">(</span><span class="n">SumkDFT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extends the SumkDFT class with some tools for analysing the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SumkDFTTools.__init__"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf_file</span><span class="p">,</span> <span class="n">h_field</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">use_dft_blocks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dft_data</span><span class="o">=</span><span class="s">&#39;dft_input&#39;</span><span class="p">,</span> <span class="n">symmcorr_data</span><span class="o">=</span><span class="s">&#39;dft_symmcorr_input&#39;</span><span class="p">,</span>
                 <span class="n">parproj_data</span><span class="o">=</span><span class="s">&#39;dft_parproj_input&#39;</span><span class="p">,</span> <span class="n">symmpar_data</span><span class="o">=</span><span class="s">&#39;dft_symmpar_input&#39;</span><span class="p">,</span> <span class="n">bands_data</span><span class="o">=</span><span class="s">&#39;dft_bands_input&#39;</span><span class="p">,</span>
                 <span class="n">transp_data</span><span class="o">=</span><span class="s">&#39;dft_transp_input&#39;</span><span class="p">,</span> <span class="n">misc_data</span><span class="o">=</span><span class="s">&#39;dft_misc_input&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of the class. Parameters are exactly as for SumKDFT.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">SumkDFT</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf_file</span><span class="o">=</span><span class="n">hdf_file</span><span class="p">,</span> <span class="n">h_field</span><span class="o">=</span><span class="n">h_field</span><span class="p">,</span> <span class="n">use_dft_blocks</span><span class="o">=</span><span class="n">use_dft_blocks</span><span class="p">,</span>
                         <span class="n">dft_data</span><span class="o">=</span><span class="n">dft_data</span><span class="p">,</span> <span class="n">symmcorr_data</span><span class="o">=</span><span class="n">symmcorr_data</span><span class="p">,</span> <span class="n">parproj_data</span><span class="o">=</span><span class="n">parproj_data</span><span class="p">,</span>
                         <span class="n">symmpar_data</span><span class="o">=</span><span class="n">symmpar_data</span><span class="p">,</span> <span class="n">bands_data</span><span class="o">=</span><span class="n">bands_data</span><span class="p">,</span> <span class="n">transp_data</span><span class="o">=</span><span class="n">transp_data</span><span class="p">,</span>
                         <span class="n">misc_data</span><span class="o">=</span><span class="n">misc_data</span><span class="p">)</span></div>

    <span class="c"># Uses .data of only GfReFreq objects.</span>
<div class="viewcode-block" id="SumkDFTTools.dos_wannier_basis"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.dos_wannier_basis">[docs]</a>    <span class="k">def</span> <span class="nf">dos_wannier_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">broadening</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">with_dc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">save_to_file</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the density of states in the basis of the Wannier functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mu : double, optional</span>
<span class="sd">             Chemical potential, overrides the one stored in the hdf5 archive.</span>
<span class="sd">        broadening : double, optional</span>
<span class="sd">                     Lorentzian broadening of the spectra. If not given, standard value of lattice_gf is used.</span>
<span class="sd">        mesh : real frequency MeshType, optional</span>
<span class="sd">               Omega mesh for the real-frequency Green&#39;s function. Given as parameter to lattice_gf.</span>
<span class="sd">        with_Sigma : boolean, optional</span>
<span class="sd">                     If True, the self energy is used for the calculation. If false, the DOS is calculated without self energy.</span>
<span class="sd">        with_dc : boolean, optional</span>
<span class="sd">                  If True the double counting correction is used.</span>
<span class="sd">        save_to_file : boolean, optional</span>
<span class="sd">                       If True, text files with the calculated data will be created.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DOS : Dict of numpy arrays</span>
<span class="sd">              Contains the full density of states.</span>
<span class="sd">        DOSproj :  Dict of numpy arrays</span>
<span class="sd">                   DOS projected to atoms.</span>
<span class="sd">        DOSproj_orb : Dict of numpy arrays</span>
<span class="sd">                      DOS projected to atoms and resolved into orbital contributions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mesh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">with_Sigma</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;lattice_gf: Give the mesh=(om_min,om_max,n_points) for the lattice GfReFreq.&quot;</span>
        <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">om_mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">]</span>
            <span class="n">om_min</span> <span class="o">=</span> <span class="n">om_mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">om_max</span> <span class="o">=</span> <span class="n">om_mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n_om</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">om_mesh</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">,</span> <span class="n">n_om</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">,</span> <span class="n">n_om</span> <span class="o">=</span> <span class="n">mesh</span>
            <span class="n">om_mesh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">,</span> <span class="n">n_om</span><span class="p">)</span>

        <span class="n">G_loc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>
            <span class="n">spn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s">&#39;SO&#39;</span><span class="p">]]</span>
            <span class="n">glist</span> <span class="o">=</span> <span class="p">[</span><span class="n">GfReFreq</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">(</span><span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">),</span> <span class="n">n_points</span><span class="o">=</span><span class="n">n_om</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">inner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gf_struct_sumk</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]]</span>
            <span class="n">G_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">BlockGf</span><span class="p">(</span><span class="n">name_list</span><span class="o">=</span><span class="n">spn</span><span class="p">,</span> <span class="n">block_list</span><span class="o">=</span><span class="n">glist</span><span class="p">,</span> <span class="n">make_copies</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>
            <span class="n">G_loc</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>

        <span class="n">DOS</span> <span class="o">=</span> <span class="p">{</span><span class="n">sp</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_om</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]}</span>
        <span class="n">DOSproj</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inequiv_shells</span><span class="p">)]</span>
        <span class="n">DOSproj_orb</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inequiv_shells</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inequiv_shells</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s">&#39;SO&#39;</span><span class="p">]]:</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s">&#39;dim&#39;</span><span class="p">]</span>
                <span class="n">DOSproj</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_om</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
                <span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">n_om</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>

        <span class="n">ikarray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">mpi</span><span class="o">.</span><span class="n">slice_array</span><span class="p">(</span><span class="n">ikarray</span><span class="p">):</span>

            <span class="n">G_latt_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_gf</span><span class="p">(</span>
                <span class="n">ik</span><span class="o">=</span><span class="n">ik</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">iw_or_w</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">broadening</span><span class="o">=</span><span class="n">broadening</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="n">with_Sigma</span><span class="p">,</span> <span class="n">with_dc</span><span class="o">=</span><span class="n">with_dc</span><span class="p">)</span>
            <span class="n">G_latt_w</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_weights</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>

            <span class="c"># Non-projected DOS</span>
            <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_latt_w</span><span class="p">:</span>
                    <span class="n">DOS</span><span class="p">[</span><span class="n">bname</span><span class="p">][</span><span class="n">iom</span><span class="p">]</span> <span class="o">-=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iom</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">/</span> \
                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

            <span class="c"># Projected DOS:</span>
            <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">downfold</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">icrsh</span><span class="p">,</span> <span class="n">bname</span><span class="p">,</span> <span class="n">G_latt_w</span><span class="p">[</span>
                                                <span class="n">bname</span><span class="p">],</span> <span class="n">gf</span><span class="p">)</span>  <span class="c"># downfolding G</span>
                <span class="n">G_loc</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span>

        <span class="c"># Collect data from mpi:</span>
        <span class="k">for</span> <span class="n">bname</span> <span class="ow">in</span> <span class="n">DOS</span><span class="p">:</span>
            <span class="n">DOS</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">DOS</span><span class="p">[</span><span class="n">bname</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>
            <span class="n">G_loc</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">mpi</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">icrsh</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

        <span class="c"># Symmetrize and rotate to local coord. system if needed:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symm_op</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">G_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmcorr</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">G_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rotations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]:</span>
                    <span class="n">G_loc</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotloc</span><span class="p">(</span>
                        <span class="n">icrsh</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;toLocal&#39;</span><span class="p">)</span>

        <span class="c"># G_loc can now also be used to look at orbitally-resolved quantities</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inequiv_shells</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]]:</span>  <span class="c"># loop over spins</span>
                <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                    <span class="n">DOSproj</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">bname</span><span class="p">][</span><span class="n">iom</span><span class="p">]</span> <span class="o">-=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iom</span><span class="p">,</span>
                                                        <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">bname</span><span class="p">][</span>
                    <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0j</span><span class="o">*</span><span class="p">(</span><span class="n">gf</span><span class="o">-</span><span class="n">gf</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:]</span>

        <span class="c"># Write to files</span>
        <span class="k">if</span> <span class="n">save_to_file</span> <span class="ow">and</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;DOS_wann_</span><span class="si">%s</span><span class="s">.dat&#39;</span> <span class="o">%</span> <span class="n">sp</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">om_mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">DOS</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c"># Partial</span>
                <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inequiv_shells</span><span class="p">):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;DOS_wann_</span><span class="si">%s</span><span class="s">_proj</span><span class="si">%s</span><span class="s">.dat&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ish</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">om_mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">DOSproj</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c"># Orbitally-resolved</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s">&#39;dim&#39;</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s">&#39;dim&#39;</span><span class="p">]):</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;DOS_wann_&#39;</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="s">&#39;_proj&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ish</span><span class="p">)</span> <span class="o">+</span>
                                     <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.dat&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">om_mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">DOS</span><span class="p">,</span> <span class="n">DOSproj</span><span class="p">,</span> <span class="n">DOSproj_orb</span></div>

    <span class="c"># Uses .data of only GfReFreq objects.</span>
<div class="viewcode-block" id="SumkDFTTools.dos_parproj_basis"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.dos_parproj_basis">[docs]</a>    <span class="k">def</span> <span class="nf">dos_parproj_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">broadening</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">with_dc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">save_to_file</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the orbitally-resolved DOS.</span>
<span class="sd">        Different to dos_Wannier_basis is that here we calculate projections also to non-Wannier projectors, in the</span>
<span class="sd">        flavour of Wien2k QTL calculatuions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mu : double, optional</span>
<span class="sd">             Chemical potential, overrides the one stored in the hdf5 archive.</span>
<span class="sd">        broadening : double, optional</span>
<span class="sd">                     Lorentzian broadening of the spectra. If not given, standard value of lattice_gf is used.</span>
<span class="sd">        mesh : real frequency MeshType, optional</span>
<span class="sd">               Omega mesh for the real-frequency Green&#39;s function. Given as parameter to lattice_gf.</span>
<span class="sd">        with_Sigma : boolean, optional</span>
<span class="sd">                     If True, the self energy is used for the calculation. If false, the DOS is calculated without self energy.</span>
<span class="sd">        with_dc : boolean, optional</span>
<span class="sd">                  If True the double counting correction is used.</span>
<span class="sd">        save_to_file : boolean, optional</span>
<span class="sd">                       If True, text files with the calculated data will be created.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DOS : Dict of numpy arrays</span>
<span class="sd">              Contains the full density of states.</span>
<span class="sd">        DOSproj :  Dict of numpy arrays</span>
<span class="sd">                   DOS projected to atoms.</span>
<span class="sd">        DOSproj_orb : Dict of numpy arrays</span>
<span class="sd">                      DOS projected to atoms and resolved into orbital contributions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">things_to_read</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;n_parproj&#39;</span><span class="p">,</span> <span class="s">&#39;proj_mat_all&#39;</span><span class="p">,</span>
                          <span class="s">&#39;rot_mat_all&#39;</span><span class="p">,</span> <span class="s">&#39;rot_mat_all_time_inv&#39;</span><span class="p">]</span>
        <span class="n">value_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_input_from_hdf</span><span class="p">(</span>
            <span class="n">subgrp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parproj_data</span><span class="p">,</span> <span class="n">things_to_read</span><span class="o">=</span><span class="n">things_to_read</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_read</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value_read</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symm_op</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmpar</span> <span class="o">=</span> <span class="n">Symmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdf_file</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symmpar_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mesh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">with_Sigma</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;lattice_gf: Give the mesh=(om_min,om_max,n_points) for the lattice GfReFreq.&quot;</span>
        <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">om_mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">]</span>
            <span class="n">om_min</span> <span class="o">=</span> <span class="n">om_mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">om_max</span> <span class="o">=</span> <span class="n">om_mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n_om</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">om_mesh</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">,</span> <span class="n">n_om</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">,</span> <span class="n">n_om</span> <span class="o">=</span> <span class="n">mesh</span>
            <span class="n">om_mesh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">,</span> <span class="n">n_om</span><span class="p">)</span>

        <span class="n">G_loc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]</span>
        <span class="n">gf_struct_parproj</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="n">glist</span> <span class="o">=</span> <span class="p">[</span><span class="n">GfReFreq</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">(</span><span class="n">om_min</span><span class="p">,</span> <span class="n">om_max</span><span class="p">),</span> <span class="n">n_points</span><span class="o">=</span><span class="n">n_om</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">inner</span> <span class="ow">in</span> <span class="n">gf_struct_parproj</span><span class="p">[</span><span class="n">ish</span><span class="p">]]</span>
            <span class="n">G_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">BlockGf</span><span class="p">(</span><span class="n">name_list</span><span class="o">=</span><span class="n">spn</span><span class="p">,</span> <span class="n">block_list</span><span class="o">=</span><span class="n">glist</span><span class="p">,</span> <span class="n">make_copies</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>

        <span class="n">DOS</span> <span class="o">=</span> <span class="p">{</span><span class="n">sp</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_om</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]}</span>
        <span class="n">DOSproj</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
        <span class="n">DOSproj_orb</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]:</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]</span>
                <span class="n">DOSproj</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_om</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
                <span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">n_om</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>

        <span class="n">ikarray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">mpi</span><span class="o">.</span><span class="n">slice_array</span><span class="p">(</span><span class="n">ikarray</span><span class="p">):</span>

            <span class="n">G_latt_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_gf</span><span class="p">(</span>
                <span class="n">ik</span><span class="o">=</span><span class="n">ik</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">iw_or_w</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">broadening</span><span class="o">=</span><span class="n">broadening</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="n">with_Sigma</span><span class="p">,</span> <span class="n">with_dc</span><span class="o">=</span><span class="n">with_dc</span><span class="p">)</span>
            <span class="n">G_latt_w</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_weights</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>

            <span class="c"># Non-projected DOS</span>
            <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_latt_w</span><span class="p">:</span>
                    <span class="n">DOS</span><span class="p">[</span><span class="n">bname</span><span class="p">][</span><span class="n">iom</span><span class="p">]</span> <span class="o">-=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iom</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">/</span> \
                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

            <span class="c"># Projected DOS:</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_parproj</span><span class="p">[</span><span class="n">ish</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">downfold</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">ish</span><span class="p">,</span> <span class="n">bname</span><span class="p">,</span> <span class="n">G_latt_w</span><span class="p">[</span>
                                                    <span class="n">bname</span><span class="p">],</span> <span class="n">gf</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">ir</span><span class="o">=</span><span class="n">ir</span><span class="p">)</span>
                    <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span>

        <span class="c"># Collect data from mpi:</span>
        <span class="k">for</span> <span class="n">bname</span> <span class="ow">in</span> <span class="n">DOS</span><span class="p">:</span>
            <span class="n">DOS</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">DOS</span><span class="p">[</span><span class="n">bname</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">mpi</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

        <span class="c"># Symmetrize and rotate to local coord. system if needed:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symm_op</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">G_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmpar</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">G_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rotations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]:</span>
                    <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotloc</span><span class="p">(</span>
                        <span class="n">ish</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;toLocal&#39;</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">)</span>

        <span class="c"># G_loc can now also be used to look at orbitally-resolved quantities</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                    <span class="n">DOSproj</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">bname</span><span class="p">][</span><span class="n">iom</span><span class="p">]</span> <span class="o">-=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iom</span><span class="p">,</span>
                                                        <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">bname</span><span class="p">][</span>
                    <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0j</span><span class="o">*</span><span class="p">(</span><span class="n">gf</span><span class="o">-</span><span class="n">gf</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:]</span>

        <span class="c"># Write to files</span>
        <span class="k">if</span> <span class="n">save_to_file</span> <span class="ow">and</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;DOS_parproj_</span><span class="si">%s</span><span class="s">.dat&#39;</span> <span class="o">%</span> <span class="n">sp</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">om_mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">DOS</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c"># Partial</span>
                <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;DOS_parproj_</span><span class="si">%s</span><span class="s">_proj</span><span class="si">%s</span><span class="s">.dat&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ish</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">om_mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">DOSproj</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c"># Orbitally-resolved</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]):</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;DOS_parproj_&#39;</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="s">&#39;_proj&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ish</span><span class="p">)</span> <span class="o">+</span>
                                     <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.dat&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">om_mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">DOSproj_orb</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">iom</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">DOS</span><span class="p">,</span> <span class="n">DOSproj</span><span class="p">,</span> <span class="n">DOSproj_orb</span></div>

    <span class="c"># Uses .data of only GfReFreq objects.</span>
<div class="viewcode-block" id="SumkDFTTools.spaghettis"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.spaghettis">[docs]</a>    <span class="k">def</span> <span class="nf">spaghettis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broadening</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plot_shift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">plot_range</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ishell</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">save_to_file</span><span class="o">=</span><span class="s">&#39;Akw_&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the correlated band structure using a real-frequency self energy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mu : double, optional</span>
<span class="sd">             Chemical potential, overrides the one stored in the hdf5 archive.</span>
<span class="sd">        broadening : double, optional</span>
<span class="sd">                     Lorentzian broadening of the spectra. If not given, standard value of lattice_gf is used.</span>
<span class="sd">        plot_shift : double, optional</span>
<span class="sd">                     Offset for each A(k,w) for stacked plotting of spectra.</span>
<span class="sd">        plot_range : list of double, optional</span>
<span class="sd">                     Sets the energy window for plotting to (plot_range[0],plot_range[1]). If not provided, the energy mesh of the self energy is used.</span>
<span class="sd">        ishell : integer, optional</span>
<span class="sd">                 Contains the index of the shell on which the spectral function is projected. If ishell=None, the total spectrum without projection is calculated.</span>
<span class="sd">        save_to_file : string, optional</span>
<span class="sd">                       Filename where the spectra are stored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Akw : Dict of numpy arrays</span>
<span class="sd">              Data as it is also written to the files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">&quot;Sigma_imp_w&quot;</span><span class="p">),</span> <span class="s">&quot;spaghettis: Set Sigma_imp_w first.&quot;</span>
        <span class="n">things_to_read</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;n_k&#39;</span><span class="p">,</span> <span class="s">&#39;n_orbitals&#39;</span><span class="p">,</span> <span class="s">&#39;proj_mat&#39;</span><span class="p">,</span>
                          <span class="s">&#39;hopping&#39;</span><span class="p">,</span> <span class="s">&#39;n_parproj&#39;</span><span class="p">,</span> <span class="s">&#39;proj_mat_all&#39;</span><span class="p">]</span>
        <span class="n">value_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_input_from_hdf</span><span class="p">(</span>
            <span class="n">subgrp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_data</span><span class="p">,</span> <span class="n">things_to_read</span><span class="o">=</span><span class="n">things_to_read</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_read</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value_read</span>
        <span class="k">if</span> <span class="n">ishell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">things_to_read</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;rot_mat_all&#39;</span><span class="p">,</span> <span class="s">&#39;rot_mat_all_time_inv&#39;</span><span class="p">]</span>
            <span class="n">value_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_input_from_hdf</span><span class="p">(</span>
                <span class="n">subgrp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parproj_data</span><span class="p">,</span> <span class="n">things_to_read</span><span class="o">=</span><span class="n">things_to_read</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value_read</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value_read</span>

        <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemical_potential</span>
        <span class="n">spn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">]</span>
        <span class="n">n_om</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_range</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">om_minplot</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.001</span>
            <span class="n">om_maxplot</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="n">n_om</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.001</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">om_minplot</span> <span class="o">=</span> <span class="n">plot_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">om_maxplot</span> <span class="o">=</span> <span class="n">plot_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ishell</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Akw</span> <span class="o">=</span> <span class="p">{</span><span class="n">sp</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">,</span> <span class="n">n_om</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Akw</span> <span class="o">=</span> <span class="p">{</span><span class="n">sp</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ishell</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">,</span> <span class="n">n_om</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ishell</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gf_struct_parproj</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ishell</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">]</span>
            <span class="n">G_loc</span> <span class="o">=</span> <span class="n">BlockGf</span><span class="p">(</span><span class="n">name_block_generator</span><span class="o">=</span><span class="p">[(</span><span class="n">block</span><span class="p">,</span> <span class="n">GfReFreq</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">))</span>
                                                  <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">inner</span> <span class="ow">in</span> <span class="n">gf_struct_parproj</span><span class="p">],</span> <span class="n">make_copies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">G_loc</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>

        <span class="n">ikarray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">mpi</span><span class="o">.</span><span class="n">slice_array</span><span class="p">(</span><span class="n">ikarray</span><span class="p">):</span>

            <span class="n">G_latt_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_gf</span><span class="p">(</span>
                <span class="n">ik</span><span class="o">=</span><span class="n">ik</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">iw_or_w</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">broadening</span><span class="o">=</span><span class="n">broadening</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ishell</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Non-projected A(k,w)</span>
                <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">om_minplot</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">om_maxplot</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_latt_w</span><span class="p">:</span>
                            <span class="n">Akw</span><span class="p">[</span><span class="n">bname</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="n">iom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iom</span><span class="p">,</span> <span class="p">:,</span>
                                                           <span class="p">:]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="c"># shift Akw for plotting stacked k-resolved eps(k)</span>
                        <span class="c"># curves</span>
                        <span class="n">Akw</span><span class="p">[</span><span class="n">bname</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="n">iom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ik</span> <span class="o">*</span> <span class="n">plot_shift</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c"># ishell not None</span>
                <span class="c"># Projected A(k,w):</span>
                <span class="n">G_loc</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">G_loc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_parproj</span><span class="p">[</span><span class="n">ishell</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">downfold</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">ishell</span><span class="p">,</span> <span class="n">bname</span><span class="p">,</span> <span class="n">G_latt_w</span><span class="p">[</span>
                                                    <span class="n">bname</span><span class="p">],</span> <span class="n">gf</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">ir</span><span class="o">=</span><span class="n">ir</span><span class="p">)</span>
                    <span class="n">G_loc</span> <span class="o">+=</span> <span class="n">tmp</span>

                <span class="c"># Rotate to local frame</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rotations</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_loc</span><span class="p">:</span>
                        <span class="n">G_loc</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotloc</span><span class="p">(</span>
                            <span class="n">ishell</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;toLocal&#39;</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">om_minplot</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">om_maxplot</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ishell</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]):</span>
                            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
                                <span class="n">Akw</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">ish</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">iom</span><span class="p">]</span> <span class="o">=</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                    <span class="n">iom</span><span class="p">,</span> <span class="n">ish</span><span class="p">,</span> <span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="c"># Collect data from mpi</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
            <span class="n">Akw</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">Akw</span><span class="p">[</span><span class="n">sp</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_to_file</span> <span class="ow">and</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ishell</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>  <span class="c"># loop over GF blocs:</span>
                    <span class="c"># Open file for storage:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_to_file</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="s">&#39;.dat&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">om_minplot</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">om_maxplot</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">plot_shift</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">      </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                                            <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">Akw</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="n">iom</span><span class="p">]))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">     </span><span class="si">%s</span><span class="s">      </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                                            <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">Akw</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="n">iom</span><span class="p">]))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c"># ishell is not None</span>
                <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ishell</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]):</span>
                        <span class="c"># Open file for storage:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_to_file</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ishell</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span>
                                 <span class="n">sp</span> <span class="o">+</span> <span class="s">&#39;_proj&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ish</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.dat&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">om_minplot</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">om_maxplot</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">plot_shift</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
                                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">      </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">Akw</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">ish</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">iom</span><span class="p">]))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">     </span><span class="si">%s</span><span class="s">      </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">ik</span><span class="p">,</span> <span class="n">mesh</span><span class="p">[</span><span class="n">iom</span><span class="p">],</span> <span class="n">Akw</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">ish</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">iom</span><span class="p">]))</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Akw</span></div>

<div class="viewcode-block" id="SumkDFTTools.partial_charges"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.partial_charges">[docs]</a>    <span class="k">def</span> <span class="nf">partial_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">with_dc</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the orbitally-resolved density matrix for all the orbitals considered in the input, consistent with</span>
<span class="sd">        the definition of Wien2k. Hence, (possibly non-orthonormal) projectors have to be provided in the partial projectors subgroup of</span>
<span class="sd">        the hdf5 archive.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        with_Sigma : boolean, optional</span>
<span class="sd">                     If True, the self energy is used for the calculation. If false, partial charges are calculated without self-energy correction.</span>
<span class="sd">        beta : double, optional</span>
<span class="sd">               In case the self-energy correction is not used, the inverse temperature where the calculation should be done has to be given here.</span>
<span class="sd">        mu : double, optional</span>
<span class="sd">             Chemical potential, overrides the one stored in the hdf5 archive.</span>
<span class="sd">        with_dc : boolean, optional</span>
<span class="sd">                  If True the double counting correction is used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dens_mat : list of numpy array</span>
<span class="sd">                   A list of density matrices projected to all shells provided in the input.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">things_to_read</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;dens_mat_below&#39;</span><span class="p">,</span> <span class="s">&#39;n_parproj&#39;</span><span class="p">,</span>
                          <span class="s">&#39;proj_mat_all&#39;</span><span class="p">,</span> <span class="s">&#39;rot_mat_all&#39;</span><span class="p">,</span> <span class="s">&#39;rot_mat_all_time_inv&#39;</span><span class="p">]</span>
        <span class="n">value_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_input_from_hdf</span><span class="p">(</span>
            <span class="n">subgrp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parproj_data</span><span class="p">,</span> <span class="n">things_to_read</span><span class="o">=</span><span class="n">things_to_read</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_read</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value_read</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symm_op</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmpar</span> <span class="o">=</span> <span class="n">Symmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdf_file</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symmpar_data</span><span class="p">)</span>

        <span class="n">spn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]</span>
        <span class="n">ntoi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_names_to_ind</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">]</span>
        <span class="c"># Density matrix in the window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dens_mat_window</span> <span class="o">=</span> <span class="p">[[</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
                                <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spn</span><span class="p">))]</span>
        <span class="c"># Set up G_loc</span>
        <span class="n">gf_struct_parproj</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shells</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="s">&#39;dim&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">with_Sigma</span><span class="p">:</span>
            <span class="n">G_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">BlockGf</span><span class="p">(</span><span class="n">name_block_generator</span><span class="o">=</span><span class="p">[(</span><span class="n">block</span><span class="p">,</span> <span class="n">GfImFreq</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_iw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">))</span>
                                                   <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">inner</span> <span class="ow">in</span> <span class="n">gf_struct_parproj</span><span class="p">[</span><span class="n">ish</span><span class="p">]],</span> <span class="n">make_copies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_iw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">beta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">G_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">BlockGf</span><span class="p">(</span><span class="n">name_block_generator</span><span class="o">=</span><span class="p">[(</span><span class="n">block</span><span class="p">,</span> <span class="n">GfImFreq</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">))</span>
                                                   <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">inner</span> <span class="ow">in</span> <span class="n">gf_struct_parproj</span><span class="p">[</span><span class="n">ish</span><span class="p">]],</span> <span class="n">make_copies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>

        <span class="n">ikarray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">mpi</span><span class="o">.</span><span class="n">slice_array</span><span class="p">(</span><span class="n">ikarray</span><span class="p">):</span>

            <span class="n">G_latt_iw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_gf</span><span class="p">(</span>
                <span class="n">ik</span><span class="o">=</span><span class="n">ik</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">iw_or_w</span><span class="o">=</span><span class="s">&quot;iw&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="n">with_Sigma</span><span class="p">,</span> <span class="n">with_dc</span><span class="o">=</span><span class="n">with_dc</span><span class="p">)</span>
            <span class="n">G_latt_iw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_weights</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_parproj</span><span class="p">[</span><span class="n">ish</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">downfold</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">ish</span><span class="p">,</span> <span class="n">bname</span><span class="p">,</span> <span class="n">G_latt_iw</span><span class="p">[</span>
                                                    <span class="n">bname</span><span class="p">],</span> <span class="n">gf</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">ir</span><span class="o">=</span><span class="n">ir</span><span class="p">)</span>
                    <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span>

        <span class="c"># Collect data from mpi:</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">mpi</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

        <span class="c"># Symmetrize and rotate to local coord. system if needed:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symm_op</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">G_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmpar</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">G_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rotations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]:</span>
                    <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">][</span><span class="n">bname</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotloc</span><span class="p">(</span>
                        <span class="n">ish</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;toLocal&#39;</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">):</span>
            <span class="n">isp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dens_mat_window</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ish</span><span class="p">]</span> <span class="o">=</span> <span class="n">G_loc</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">density</span><span class="p">()[</span><span class="n">bname</span><span class="p">]</span>
                <span class="n">isp</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Add density matrices to get the total:</span>
        <span class="n">dens_mat</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">dens_mat_below</span><span class="p">[</span><span class="n">ntoi</span><span class="p">[</span><span class="n">spn</span><span class="p">[</span><span class="n">isp</span><span class="p">]]][</span><span class="n">ish</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens_mat_window</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ish</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_shells</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spn</span><span class="p">))]</span>

        <span class="k">return</span> <span class="n">dens_mat</span></div>

<div class="viewcode-block" id="SumkDFTTools.print_hamiltonian"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.print_hamiltonian">[docs]</a>    <span class="k">def</span> <span class="nf">print_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the Kohn-Sham Hamiltonian to the text files hamup.dat and hamdn.dat (no spin orbit-coupling), or to ham.dat (with spin-orbit coupling).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SP</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">SO</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;hamup.dat&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;hamdn.dat&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_orbitals</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                    <span class="n">f1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_orbitals</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">))</span>
                <span class="n">f1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">f1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;ham.dat&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_orbitals</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c"># ----------------- transport -----------------------</span>

<div class="viewcode-block" id="SumkDFTTools.read_transport_input_from_hdf"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.read_transport_input_from_hdf">[docs]</a>    <span class="k">def</span> <span class="nf">read_transport_input_from_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Reads the data for transport calculations from the hdf5 archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thingstoread</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;band_window_optics&#39;</span><span class="p">,</span> <span class="s">&#39;velocities_k&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_input_from_hdf</span><span class="p">(</span>
            <span class="n">subgrp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transp_data</span><span class="p">,</span> <span class="n">things_to_read</span><span class="o">=</span><span class="n">thingstoread</span><span class="p">)</span>
        <span class="n">thingstoread</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;band_window&#39;</span><span class="p">,</span> <span class="s">&#39;lattice_angles&#39;</span><span class="p">,</span> <span class="s">&#39;lattice_constants&#39;</span><span class="p">,</span>
                        <span class="s">&#39;lattice_type&#39;</span><span class="p">,</span> <span class="s">&#39;n_symmetries&#39;</span><span class="p">,</span> <span class="s">&#39;rot_symmetries&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_input_from_hdf</span><span class="p">(</span>
            <span class="n">subgrp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_data</span><span class="p">,</span> <span class="n">things_to_read</span><span class="o">=</span><span class="n">thingstoread</span><span class="p">)</span></div>

<div class="viewcode-block" id="SumkDFTTools.cellvolume"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.cellvolume">[docs]</a>    <span class="k">def</span> <span class="nf">cellvolume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lattice_type</span><span class="p">,</span> <span class="n">lattice_constants</span><span class="p">,</span> <span class="n">latticeangle</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Determines the conventional und primitive unit cell volumes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lattice_type : string</span>
<span class="sd">            Lattice type according to the Wien2k convention (P, F, B, R, H, CXY, CYZ, CXZ).</span>
<span class="sd">        lattice_constants : list of double</span>
<span class="sd">            Lattice constants (a, b, c).</span>
<span class="sd">        lattice angles : list of double</span>
<span class="sd">            Lattice angles (:math:`\alpha, \beta, \gamma`).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vol_c : double</span>
<span class="sd">            Conventional unit cell volume.</span>
<span class="sd">        vol_p : double</span>
<span class="sd">            Primitive unit cell volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">lattice_constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">lattice_constants</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">lattice_constants</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">c_al</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">latticeangle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">c_be</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">latticeangle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">c_ga</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">latticeangle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">vol_c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> \
            <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">c_al</span> <span class="o">*</span> <span class="n">c_be</span> <span class="o">*</span> <span class="n">c_ga</span> <span class="o">-</span>
                       <span class="n">c_al</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c_be</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c_ga</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">det</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;P&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;R&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
               <span class="s">&quot;H&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CXY&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;CYZ&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;CXZ&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
        <span class="n">vol_p</span> <span class="o">=</span> <span class="n">vol_c</span> <span class="o">/</span> <span class="n">det</span><span class="p">[</span><span class="n">lattice_type</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">vol_c</span><span class="p">,</span> <span class="n">vol_p</span></div>

    <span class="c"># Uses .data of only GfReFreq objects.</span>
<div class="viewcode-block" id="SumkDFTTools.transport_distribution"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.transport_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">transport_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;xx&#39;</span><span class="p">],</span> <span class="n">energy_window</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">Om_mesh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">n_om</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">broadening</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Calculates the transport distribution </span>

<span class="sd">        .. math::</span>
<span class="sd">           \Gamma_{\alpha\beta}\left(\omega+\Omega/2, \omega-\Omega/2\right) = \frac{1}{V} \sum_k Tr\left(v_{k,\alpha}A_{k}(\omega+\Omega/2)v_{k,\beta}A_{k}\left(\omega-\Omega/2\right)\right)</span>

<span class="sd">        in the direction :math:`\alpha\beta`. The velocities :math:`v_{k}` are read from the transport subgroup of the hdf5 archive. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        beta : double</span>
<span class="sd">            Inverse temperature :math:`\beta`.</span>
<span class="sd">        directions : list of double, optional</span>
<span class="sd">            :math:`\alpha\beta` e.g.: [&#39;xx&#39;,&#39;yy&#39;,&#39;zz&#39;,&#39;xy&#39;,&#39;xz&#39;,&#39;yz&#39;].</span>
<span class="sd">        energy_window : list of double, optional</span>
<span class="sd">            Specifies the upper and lower limit of the frequency integration for :math:`\Omega=0.0`. The window is automatically enlarged by the largest :math:`\Omega` value, </span>
<span class="sd">            hence the integration is performed in the interval [energy_window[0]-max(Om_mesh), energy_window[1]+max(Om_mesh)].</span>
<span class="sd">        Om_mesh : list of double, optional</span>
<span class="sd">            :math:`\Omega` frequency mesh of the optical conductivity. For the conductivity and the Seebeck coefficient :math:`\Omega=0.0` has to be</span>
<span class="sd">            part of the mesh. In the current version Om_mesh is repined to the mesh provided by the self-energy! The actual mesh is printed on the screen and stored as</span>
<span class="sd">            member Om_mesh.</span>
<span class="sd">        with_Sigma : boolean, optional</span>
<span class="sd">            Determines whether the calculation is performed with or without self energy. If this parameter is set to False the self energy is set to zero (i.e. the DFT band </span>
<span class="sd">            structure :math:`A(k,\omega)` is used). Note: For with_Sigma=False it is necessary to specify the parameters energy_window, n_om and broadening.</span>
<span class="sd">        n_om : integer, optional</span>
<span class="sd">            Number of equidistant frequency points in the interval [energy_window[0]-max(Om_mesh), energy_window[1]+max(Om_mesh)]. This parameters is only used if</span>
<span class="sd">            with_Sigma = False.</span>
<span class="sd">        broadening : double, optional</span>
<span class="sd">            Lorentzian broadening. It is necessary to specify the boradening if with_Sigma = False, otherwise this parameter can be set to 0.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Check if wien converter was called and read transport subgroup form</span>
        <span class="c"># hdf file</span>
        <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="n">HDFArchive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdf_file</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transp_data</span> <span class="ow">in</span> <span class="n">ar</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">,</span> <span class="s">&quot;transport_distribution: No </span><span class="si">%s</span><span class="s"> subgroup in hdf file found! Call convert_transp_input first.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">transp_data</span>
            <span class="c"># check if outputs file was converted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s">&#39;n_symmetries&#39;</span> <span class="ow">in</span> <span class="n">ar</span><span class="p">[</span><span class="s">&#39;dft_misc_input&#39;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">,</span>  <span class="s">&quot;transport_distribution: n_symmetries missing. Check if case.outputs file is present and call convert_misc_input() or convert_dft_input().&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_transport_input_from_hdf</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="c"># k-dependent-projections.</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_dep_projection</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;transport_distribution: k dependent projection is not implemented!&quot;</span>
            <span class="c"># positive Om_mesh</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">Om</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">Om</span> <span class="ow">in</span> <span class="n">Om_mesh</span><span class="p">),</span> <span class="s">&quot;transport_distribution: Om_mesh should not contain negative values!&quot;</span>

        <span class="c"># Check if energy_window is sufficiently large and correct</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;transport_distribution: energy_window wrong!&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span><span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span><span class="o">-</span><span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beta</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-5</span>
                <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span><span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span><span class="o">-</span><span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">beta</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">):</span>
            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span>
                <span class="s">&quot;</span><span class="se">\n</span><span class="s">####################################################################&quot;</span><span class="p">)</span>
            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span>
                <span class="s">&quot;transport_distribution: WARNING - energy window might be too narrow!&quot;</span><span class="p">)</span>
            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span>
                <span class="s">&quot;####################################################################</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># up and down are equivalent if SP = 0</span>
        <span class="n">n_inequiv_spin_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SP</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">SO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span>
        <span class="n">dir_to_int</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

        <span class="c"># calculate A(k,w)</span>
        <span class="c">#######################################</span>

        <span class="c"># Define mesh for Green&#39;s function and in the specified energy window</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">with_Sigma</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">])</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemical_potential</span>
            <span class="n">n_om</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span>
            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s">&quot;Using omega mesh provided by Sigma!&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">energy_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Find according window in Sigma mesh</span>
                <span class="n">ioffset</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">&lt;</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">&gt;=</span> <span class="n">energy_window</span><span class="p">[</span>
                                                          <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">&lt;=</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">))]</span>
                <span class="n">n_om</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span>

                <span class="c"># Truncate Sigma to given omega window</span>
                <span class="c"># In the future there should be an option in gf to manipulate the mesh (e.g. truncate) directly.</span>
                <span class="c"># For now we stick with this:</span>
                <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>
                    <span class="n">Sigma_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">spn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s">&#39;SO&#39;</span><span class="p">]]</span>
                    <span class="n">glist</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="n">GfReFreq</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span>
                                              <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">n_points</span><span class="o">=</span><span class="n">n_om</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">inner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gf_struct_sumk</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]</span> <span class="o">=</span> <span class="n">BlockGf</span><span class="p">(</span>
                        <span class="n">name_list</span><span class="o">=</span><span class="n">spn</span><span class="p">,</span> <span class="n">block_list</span><span class="o">=</span><span class="n">glist</span><span class="p">(),</span> <span class="n">make_copies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_imp_w</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">iL</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">iR</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">iom</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                                    <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iom</span><span class="p">,</span> <span class="n">iL</span><span class="p">,</span> <span class="n">iR</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sigma_save</span><span class="p">[</span>
                                        <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ioffset</span> <span class="o">+</span> <span class="n">iom</span><span class="p">,</span> <span class="n">iL</span><span class="p">,</span> <span class="n">iR</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">n_om</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;transport_distribution: Number of omega points (n_om) needed to calculate transport distribution!&quot;</span>
            <span class="k">assert</span> <span class="n">energy_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;transport_distribution: Energy window needed to calculate transport distribution!&quot;</span>
            <span class="k">assert</span> <span class="n">broadening</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">broadening</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;transport_distribution: Broadening necessary to calculate transport distribution!&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">),</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">),</span> <span class="n">n_om</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">),</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">),</span> <span class="n">n_om</span><span class="p">]</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c"># Define mesh for optic conductivity</span>
        <span class="n">d_omega</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">iOm_mesh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">round</span><span class="p">((</span><span class="n">Om</span> <span class="o">/</span> <span class="n">d_omega</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">Om</span> <span class="ow">in</span> <span class="n">Om_mesh</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span> <span class="o">=</span> <span class="n">iOm_mesh</span> <span class="o">*</span> <span class="n">d_omega</span>

        <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="k">print</span> <span class="s">&quot;Chemical potential: &quot;</span><span class="p">,</span> <span class="n">mu</span>
            <span class="k">print</span> <span class="s">&quot;Using n_om = </span><span class="si">%s</span><span class="s"> points in the energy_window [</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_om</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="k">print</span> <span class="s">&quot;where the omega vector is:&quot;</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span>
            <span class="k">print</span> <span class="s">&quot;Calculation requested for Omega mesh:   &quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Om_mesh</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;Omega mesh automatically repined to:  &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">),</span> <span class="n">n_om</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span> <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">}</span>

        <span class="c"># Sum over all k-points</span>
        <span class="n">ikarray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_k</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">mpi</span><span class="o">.</span><span class="n">slice_array</span><span class="p">(</span><span class="n">ikarray</span><span class="p">):</span>
            <span class="c"># Calculate G_w  for ik and initialize A_kw</span>
            <span class="n">G_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_gf</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">iw_or_w</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                                  <span class="n">broadening</span><span class="o">=</span><span class="n">broadening</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">with_Sigma</span><span class="o">=</span><span class="n">with_Sigma</span><span class="p">)</span>
            <span class="n">A_kw</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_orbitals</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">isp</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_orbitals</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">isp</span><span class="p">],</span> <span class="n">n_om</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_inequiv_spin_blocks</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_inequiv_spin_blocks</span><span class="p">):</span>
                <span class="c"># copy data from G_w (swapaxes is used to have omega in the 3rd</span>
                <span class="c"># dimension)</span>
                <span class="n">A_kw</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">G_w</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SO</span><span class="p">][</span>
                                          <span class="n">isp</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="c"># calculate A(k,w) for each frequency</span>
                <span class="k">for</span> <span class="n">iw</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                    <span class="n">A_kw</span><span class="p">[</span><span class="n">isp</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">iw</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">1j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">A_kw</span><span class="p">[</span><span class="n">isp</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">iw</span><span class="p">]</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A_kw</span><span class="p">[</span><span class="n">isp</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">iw</span><span class="p">])))</span>

                <span class="n">b_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_window</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span>
                            <span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">b_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_window</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span>
                            <span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">A_i</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                    <span class="n">b_min</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">b_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">v_i</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">b_min</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span>
                            <span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">b_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c"># loop over all symmetries</span>
                <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot_symmetries</span><span class="p">:</span>
                    <span class="c"># get transformed velocity under symmetry R</span>
                    <span class="n">vel_R</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocities_k</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">nu1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">nu2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_window_optics</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">vel_R</span><span class="p">[</span><span class="n">nu1</span><span class="p">][</span><span class="n">nu2</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                                <span class="n">R</span><span class="p">,</span> <span class="n">vel_R</span><span class="p">[</span><span class="n">nu1</span><span class="p">][</span><span class="n">nu2</span><span class="p">][:])</span>

                    <span class="c"># calculate Gamma_w for each direction from the velocities</span>
                    <span class="c"># vel_R and the spectral function A_kw</span>
                    <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">iw</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_om</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">)):</span>
                                <span class="k">if</span><span class="p">(</span><span class="n">iw</span> <span class="o">+</span> <span class="n">iOm_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">n_om</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="n">iw</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">+</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="n">iw</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">+</span> <span class="n">energy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                    <span class="k">continue</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">,</span> <span class="n">iw</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vel_R</span><span class="p">[</span><span class="n">v_i</span><span class="p">,</span> <span class="n">v_i</span><span class="p">,</span> <span class="n">dir_to_int</span><span class="p">[</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span>
                                                                                                  <span class="n">A_kw</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">A_i</span><span class="p">,</span> <span class="n">A_i</span><span class="p">,</span> <span class="n">iw</span> <span class="o">+</span> <span class="n">iOm_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">]]),</span> <span class="n">vel_R</span><span class="p">[</span><span class="n">v_i</span><span class="p">,</span> <span class="n">v_i</span><span class="p">,</span> <span class="n">dir_to_int</span><span class="p">[</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]),</span>
                                                                              <span class="n">A_kw</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="n">A_i</span><span class="p">,</span> <span class="n">A_i</span><span class="p">,</span> <span class="n">iw</span><span class="p">])</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_weights</span><span class="p">[</span><span class="n">ik</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span><span class="p">[</span><span class="n">direction</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
                                       <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellvolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_constants</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_angles</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_symmetries</span><span class="p">)</span></div>

<div class="viewcode-block" id="SumkDFTTools.transport_coefficient"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.transport_coefficient">[docs]</a>    <span class="k">def</span> <span class="nf">transport_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Calculates the transport coefficient A_n in a given direction for a given :math:`\Omega`. The required members (Gamma_w, directions, Om_mesh) have to be obtained first</span>
<span class="sd">        by calling the function :meth:`transport_distribution &lt;dft.sumk_dft_tools.SumkDFTTools.transport_distribution&gt;`. For n&gt;0 A is set to NaN if :math:`\Omega` is not 0.0. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        direction : string</span>
<span class="sd">           :math:`\alpha\beta` e.g.: &#39;xx&#39;,&#39;yy&#39;,&#39;zz&#39;,&#39;xy&#39;,&#39;xz&#39;,&#39;yz&#39;.</span>
<span class="sd">        iq : integer</span>
<span class="sd">            Index of :math:`\Omega` point in the member Om_mesh.</span>
<span class="sd">        n : integer</span>
<span class="sd">            Number of the desired moment of the transport distribution.</span>
<span class="sd">        beta : double</span>
<span class="sd">            Inverse temperature :math:`\beta`.</span>
<span class="sd">        method : string</span>
<span class="sd">            Integration method: cubic spline and scipy.integrate.quad (&#39;quad&#39;), simpson rule (&#39;simps&#39;), trapezoidal rule (&#39;trapz&#39;), rectangular integration (otherwise)</span>
<span class="sd">            Note that the sampling points of the the self-energy are used!</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A : double</span>
<span class="sd">            Transport coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">()):</span>
            <span class="k">return</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;Gamma_w&#39;</span><span class="p">),</span> <span class="s">&quot;transport_coefficient: Run transport_distribution first or load data from h5!&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c"># setup the integrand</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">A_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">beta</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span><span class="o">**</span><span class="n">n</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">A_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermi_dis</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">],</span> <span class="n">beta</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span>

            <span class="c"># w-integration</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;quad&#39;</span><span class="p">:</span>
                <span class="c"># quad on interpolated w-points with cubic spline</span>
                <span class="n">A_int_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">A_int</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;cubic&#39;</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">A_int_interp</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">),</span>
                         <span class="n">epsabs</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;simps&#39;</span><span class="p">:</span>
                <span class="c"># simpson rule for w-grid</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">A_int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;trapz&#39;</span><span class="p">:</span>
                <span class="c"># trapezoidal rule for w-grid</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">A_int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># rectangular integration for w-grid (orignal implementation)</span>
                <span class="n">d_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">iw</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">A</span> <span class="o">+=</span> <span class="n">A_int</span><span class="p">[</span><span class="n">iw</span><span class="p">]</span> <span class="o">*</span> <span class="n">d_w</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">SP</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">A</span></div>

<div class="viewcode-block" id="SumkDFTTools.conductivity_and_seebeck"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.conductivity_and_seebeck">[docs]</a>    <span class="k">def</span> <span class="nf">conductivity_and_seebeck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Calculates the Seebeck coefficient and the optical conductivity by calling </span>
<span class="sd">        :meth:`transport_coefficient &lt;dft.sumk_dft_tools.SumkDFTTools.transport_coefficient&gt;`. </span>
<span class="sd">        The required members (Gamma_w, directions, Om_mesh) have to be obtained first by calling the function </span>
<span class="sd">        :meth:`transport_distribution &lt;dft.sumk_dft_tools.SumkDFTTools.transport_distribution&gt;`. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        beta : double</span>
<span class="sd">            Inverse temperature :math:`\beta`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        optic_cond : dictionary of double vectors</span>
<span class="sd">            Optical conductivity in each direction and frequency given by Om_mesh.</span>

<span class="sd">        seebeck : dictionary of double</span>
<span class="sd">            Seebeck coefficient in each direction. If zero is not present in Om_mesh the Seebeck coefficient is set to NaN.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">()):</span>
            <span class="k">return</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;Gamma_w&#39;</span><span class="p">),</span> <span class="s">&quot;conductivity_and_seebeck: Run transport_distribution first or load data from h5!&quot;</span>
        <span class="n">n_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_w</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">A0</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_q</span><span class="p">,),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">}</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_q</span><span class="p">,),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seebeck</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optic_cond</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="n">n_q</span><span class="p">,),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_q</span><span class="p">):</span>
                <span class="n">A0</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport_coefficient</span><span class="p">(</span>
                    <span class="n">direction</span><span class="p">,</span> <span class="n">iq</span><span class="o">=</span><span class="n">iq</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="n">A1</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport_coefficient</span><span class="p">(</span>
                    <span class="n">direction</span><span class="p">,</span> <span class="n">iq</span><span class="o">=</span><span class="n">iq</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;A_0 in direction </span><span class="si">%s</span><span class="s"> for Omega = </span><span class="si">%.2f</span><span class="s">    </span><span class="si">%e</span><span class="s"> a.u.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">],</span> <span class="n">A0</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">])</span>
                <span class="k">print</span> <span class="s">&quot;A_1 in direction </span><span class="si">%s</span><span class="s"> for Omega = </span><span class="si">%.2f</span><span class="s">    </span><span class="si">%e</span><span class="s"> a.u.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">],</span> <span class="n">A1</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">])</span>
                <span class="k">if</span> <span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">]):</span>
                    <span class="c"># Seebeck is overwritten if there is more than one Omega =</span>
                    <span class="c"># 0 in Om_mesh</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seebeck</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> \
                        <span class="n">A1</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span> <span class="o">/</span> <span class="n">A0</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span> <span class="o">*</span> <span class="mf">86.17</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optic_cond</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> \
                <span class="n">A0</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">*</span> <span class="mf">10700.0</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_q</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;Conductivity in direction </span><span class="si">%s</span><span class="s"> for Omega = </span><span class="si">%.2f</span><span class="s">       </span><span class="si">%f</span><span class="s">  x 10^4 Ohm^-1 cm^-1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Om_mesh</span><span class="p">[</span><span class="n">iq</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">optic_cond</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">iq</span><span class="p">])):</span>
                    <span class="k">print</span> <span class="s">&quot;Seebeck in direction      </span><span class="si">%s</span><span class="s"> for Omega = 0.00      </span><span class="si">%f</span><span class="s">  x 10^(-6) V/K&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seebeck</span><span class="p">[</span><span class="n">direction</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optic_cond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seebeck</span></div>

<div class="viewcode-block" id="SumkDFTTools.fermi_dis"><a class="viewcode-back" href="../../reference/sumk_dft_tools.html#dft.sumk_dft_tools.SumkDFTTools.fermi_dis">[docs]</a>    <span class="k">def</span> <span class="nf">fermi_dis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Fermi distribution.</span>

<span class="sd">        .. math::</span>
<span class="sd">           f(x) = 1/(e^x+1).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        w : double</span>
<span class="sd">           frequency</span>
<span class="sd">        beta : double</span>
<span class="sd">           inverse temperature</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f : double</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../index.html">Home</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2011-2013, M. Aichhorn, L. Pourovskii, V. Vildosola, C. Martins.
    </div>
  </body>
</html>